<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CapÃ­tulo 16 - Diagramas C4 - Sistema Bancario BP</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    
    </style>
  </head>
  <body>
     <div class="nav-header">
      <h2>CapÃ­tulo 17: Anexo diagramas C4 Models</h2>
      <div class="nav-buttons">
        <a href="capitulo_15.html" class="nav-btn">â† Anterior</a>
        <a href="index.html" class="nav-btn">Ãndice</a>
        <a href="capitulo_17.html" class="nav-btn">Siguiente â†’</a>
      </div>
    </div>
    <h1>ğŸ“ Diagramas C4 - Sistema Bancario BP</h1>

    <div class="info-box">
      <strong>ğŸ“š Modelo C4 (Context, Containers, Components, Code)</strong>
      <p>
        El modelo C4 es un enfoque de "zoom" para documentar arquitecturas de
        software, creado por Simon Brown. Proporciona diferentes niveles de
        abstracciÃ³n para diferentes audiencias:
      </p>
      <ul>
        <li>
          <strong>Nivel 1 - Contexto:</strong> Vista de alto nivel del sistema
          en su entorno (para stakeholders no tÃ©cnicos)
        </li>
        <li>
          <strong>Nivel 2 - Contenedores:</strong> Aplicaciones y servicios que
          componen el sistema (para tÃ©cnicos)
        </li>
        <li>
          <strong>Nivel 3 - Componentes:</strong> Componentes internos de un
          contenedor especÃ­fico (para desarrolladores)
        </li>
        <li>
          <strong>Nivel 4 - CÃ³digo:</strong> ImplementaciÃ³n detallada (opcional,
          no incluido aquÃ­)
        </li>
      </ul>
      <p>
        ğŸ”— MÃ¡s informaciÃ³n:
        <a href="https://c4model.info/" target="_blank">c4model.info</a>
      </p>
    </div>

    <!-- ============================================ -->
    <!-- DIAGRAMA 1: CONTEXTO (C4 Level 1) -->
    <!-- ============================================ -->

    <h2>ğŸ“ Diagrama 1: Contexto del Sistema (C4 Level 1)</h2>

      <div class="section">
        <strong>ğŸ¯ Audiencia:</strong> Stakeholders no tÃ©cnicos, gerencia,
        usuarios de negocio<br />
        <strong>ğŸ“‹ PropÃ³sito:</strong> Mostrar el sistema en su entorno
        completo, identificando usuarios y sistemas externos con los que
        interactÃºa<br />
        <strong>ğŸ” Nivel de detalle:</strong> Alto nivel, sin detalles tÃ©cnicos
        de implementaciÃ³n
      </div>

    <div class="diagram">
      <div class="diagram-title">Contexto del Sistema Bancario BP</div>



      <pre class="mermaid">
flowchart TD
    %% === TÃTULO PRINCIPAL ===
    Title[<h2>ğŸ¦ Sistema Bancario BP</h2><br/>Diagrama de Contexto - Arquitectura del Sistema]

    %% === USUARIOS DEL SISTEMA ===
    subgraph Users[ğŸ‘¥ Usuarios del Sistema]
        direction LR
        U1[ğŸ‘¤<br/><b>Cliente Bancario</b><br/><small>Realiza operaciones bancarias<br/>vÃ­a web o app mÃ³vil</small>]
        U2[ğŸ‘¨â€ğŸ’¼<br/><b>Empleado del Banco</b><br/><small>Gestiona cuentas y aprueba<br/>transacciones</small>]
        U3[ğŸ‘¨â€ğŸ’»<br/><b>Administrador</b><br/><small>Gestiona y monitorea<br/>la plataforma</small>]
    end

    %% === SISTEMA PRINCIPAL ===
    BP[ğŸ¦<br/><b>Sistema Bancario BP</b><br/><small>Plataforma bancaria digital completa<br/>GestiÃ³n de cuentas, transferencias, pagos<br/>y consultas en tiempo real</small>]

    %% === SISTEMAS EXTERNOS ORGANIZADOS ===
    subgraph ExternalSystems[ğŸ”— Sistemas Externos]
        direction TB
        
        subgraph Comms[ğŸ“§ Comunicaciones]
            E1[ğŸ“§<br/><b>Servicio de Email</b>]
            E2[ğŸ“±<br/><b>Proveedor SMS</b>]
            E3[ğŸ””<br/><b>Firebase FCM</b>]
        end

        subgraph Payments[ğŸ’³ Pagos e Identidad]
            E4[ğŸ’¸<br/><b>Red ACH</b>]
            E5[ğŸ’³<br/><b>Gateway de Pagos</b>]
            E6[ğŸ†”<br/><b>Proveedor Identidad</b>]
        end

        subgraph Infra[ğŸ› ï¸ Infraestructura]
            E7[â˜ï¸<br/><b>Almacenamiento Cloud</b>]
            E8[ğŸ“Š<br/><b>Monitoreo</b>]
        end
    end

    %% === CONEXIONES CON ETIQUETAS ===
    U1 -->|Realiza operaciones bancarias<br/>Web & App MÃ³vil<br/>HTTPS/WSS| BP
    U2 -->|Gestiona operaciones<br/>Aprueba transacciones<br/>HTTPS| BP
    U3 -->|Administra y monitorea<br/>el sistema<br/>HTTPS/SSH| BP

    BP -->|EnvÃ­a notificaciones<br/>por correo<br/>SMTP/API REST| E1
    BP -->|EnvÃ­a mensajes SMS<br/>y cÃ³digos OTP<br/>API REST| E2
    BP -->|EnvÃ­a notificaciones<br/>push mÃ³viles<br/>FCM API| E3
    BP -->|Procesa transferencias<br/>interbancarias<br/>ISO 8583/SWIFT| E4
    BP -->|Procesa pagos<br/>con tarjeta<br/>API REST/Webhooks| E5
    BP -->|Verifica identidad<br/>de usuarios - KYC<br/>API REST| E6
    BP -->|Almacena documentos<br/>y backups<br/>S3 API| E7
    BP -->|EnvÃ­a mÃ©tricas<br/>y logs<br/>Prometheus/Loki| E8

    %% === ESTILOS CON COLORES PASTEL ===
    classDef title fill:#FCE4EC,stroke:#C2185B,stroke-width:2px,rx:15,ry:15
    classDef users fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px,rx:12,ry:12
    classDef mainSystem fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,rx:12,ry:12
    classDef external fill:#FFF3E0,stroke:#FF9800,stroke-width:2px,rx:10,ry:10
    classDef comms fill:#F3E5F5,stroke:#9C27B0,stroke-width:1px,rx:8,ry:8
    classDef payments fill:#E0F2F1,stroke:#00897B,stroke-width:1px,rx:8,ry:8
    classDef infra fill:#FFEBEE,stroke:#D32F2F,stroke-width:1px,rx:8,ry:8
    classDef userItem fill:#FFFFFF,stroke:#4CAF50,stroke-width:1px,rx:8,ry:8
    classDef externalItem fill:#FFFFFF,stroke:#666666,stroke-width:1px,rx:6,ry:6

    %% APLICAR ESTILOS ===
    class Title title
    class Users users
    class BP mainSystem
    class ExternalSystems external
    class Comms comms
    class Payments payments
    class Infra infra
    class U1,U2,U3 userItem
    class E1,E2,E3,E4,E5,E6,E7,E8 externalItem

    %% ESTILOS DE LÃNEAS ===
    linkStyle 0,1,2 stroke:#4CAF50,stroke-width:2px
    linkStyle 3,4,5 stroke:#9C27B0,stroke-width:1.5px
    linkStyle 6,7,8 stroke:#00897B,stroke-width:1.5px
    linkStyle 9,10 stroke:#D32F2F,stroke-width:1.5px
    </pre>

      <div class="legend">
        <h4>ğŸ”‘ Leyenda del Diagrama de Contexto</h4>
        <ul>
          <li><strong>Person (Azul):</strong> Usuarios humanos del sistema</li>
          <li>
            <strong>System (Azul oscuro):</strong> El sistema que estamos
            documentando
          </li>
          <li>
            <strong>System_Ext (Gris):</strong> Sistemas externos fuera de
            nuestro control
          </li>
          <li>
            <strong>Rel (Flechas):</strong> Relaciones/interacciones entre
            elementos
          </li>
        </ul>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- DIAGRAMA 2: CONTENEDORES (C4 Level 2) -->
    <!-- ============================================ -->

    <h2>ğŸ“¦ Diagrama 2: Contenedores del Sistema (C4 Level 2)</h2>

   <div class="section">
        <strong>ğŸ¯ Audiencia:</strong> Arquitectos de software, lÃ­deres
        tÃ©cnicos, DevOps<br />
        <strong>ğŸ“‹ PropÃ³sito:</strong> Mostrar las aplicaciones y servicios que
        componen el sistema, sus responsabilidades y tecnologÃ­as<br />
        <strong>ğŸ” Nivel de detalle:</strong> Aplicaciones, bases de datos,
        servicios, sin entrar en componentes internos
      </div>

    <div class="diagram">
      <div class="diagram-title">
        Arquitectura de Contenedores - Sistema Bancario BP
      </div>

      <pre class="mermaid">
flowchart TD
    %% === TÃTULO PRINCIPAL ===
    Title[<h2>ğŸ¦ Sistema Bancario BP - Arquitectura de Contenedores</h2>]

    %% === USUARIOS ===
    subgraph Users[ğŸ‘¥ Usuarios]
        direction LR
        U1[ğŸ‘¤<br/><b>Cliente Bancario</b><br/><small>Accede desde web o mÃ³vil</small>]
        U2[ğŸ‘¨â€ğŸ’¼<br/><b>Empleado Banco</b><br/><small>Gestiona operaciones</small>]
    end

    %% === APLICACIONES CLIENTE ===
    subgraph ClientApps[ğŸ“± Aplicaciones Cliente]
        direction LR
        A1[ğŸ“±<br/><b>App MÃ³vil</b><br/><small>React Native<br/>iOS/Android</small>]
        A2[ğŸŒ<br/><b>App Web</b><br/><small>React.js + Vite<br/>SPA</small>]
    end

    %% === API GATEWAY ===
    GW[ğŸ”Œ<br/><b>API Gateway</b><br/><small>Kong/NGINX + Node.js<br/>OAuth 2.0, Rate Limiting</small>]

    %% === MICROSERVICIOS ACTUALIZADOS ===
    subgraph Microservices[âš™ï¸ Microservicios]
        direction TB
        
        subgraph CoreBanking[ğŸ’¼ Servicios Bancarios Core]
            M1[ğŸ”<br/><b>MS-AutenticaciÃ³n</b><br/><small>Node.js + Passport.js<br/>:3005 REST</small>]
            M2[ğŸ‘¤<br/><b>MS-Datos-Cliente</b><br/><small>Node.js + GraphQL<br/>:3004 GraphQL</small>]
            M3[ğŸ’¸<br/><b>MS-Pagos-Internos</b><br/><small>Node.js + GraphQL<br/>:3002 GraphQL</small>]
            M4[ğŸŒ<br/><b>MS-Pagos-Interbancarios</b><br/><small>Node.js + GraphQL<br/>:3003 GraphQL + SAGA</small>]
        end

        subgraph DataServices[ğŸ“Š Servicios de Datos]
            M5[ğŸ“ˆ<br/><b>MS-HistÃ³ricos</b><br/><small>Node.js + GraphQL<br/>:3001 GraphQL CQRS</small>]
            M6[ğŸ“<br/><b>MS-AuditorÃ­a</b><br/><small>Node.js + GraphQL<br/>:3006 GraphQL + Worker Pool</small>]
            M7[ğŸ“¢<br/><b>MS-Notificaciones</b><br/><small>Node.js + Bull Queue<br/>:3007 GraphQL + Workers</small>]
            M8[ğŸ“<br/><b>MS-Archivos</b><br/><small>Node.js + Multer<br/>:3008 REST</small>]
        end
    end

    %% === BASE DE DATOS ===
    subgraph Databases[ğŸ—„ï¸ Bases de Datos]
        direction LR
        DB1[ğŸ˜<br/><b>PostgreSQL<br/>Primary</b><br/><small>Cuentas, Transacciones</small>]
        DB2[ğŸ˜<br/><b>PostgreSQL<br/>Replicas</b><br/><small>Lecturas, Consultas</small>]
        DB3[ğŸƒ<br/><b>MongoDB</b><br/><small>Documentos, HistÃ³ricos, Logs</small>]
        DB4[ğŸ”´<br/><b>Redis Cluster</b><br/><small>Sesiones, Cache, Temporal</small>]
        DB5[â˜ï¸<br/><b>Cloud Storage</b><br/><small>Archivos, Documentos</small>]
    end

    %% === INFRAESTRUCTURA ===
    subgraph Infrastructure[ğŸ”„ Infraestructura]
        direction LR
        I1[ğŸ“¬<br/><b>Apache Kafka</b><br/><small>Event Streaming, CQRS</small>]
        I2[ğŸ”‘<br/><b>HashiCorp Vault</b><br/><small>Secrets, API Keys</small>]
        I3[âš¡<br/><b>Bull Queue</b><br/><small>Jobs, Workers</small>]
    end

    %% === SISTEMAS EXTERNOS ===
    subgraph External[ğŸŒ Sistemas Externos]
        direction LR
        E1[ğŸ’³<br/><b>Red ACH</b><br/><small>Transferencias Interbancarias</small>]
        E2[ğŸ””<br/><b>Firebase</b><br/><small>Push Notifications</small>]
        E3[ğŸ“§<br/><b>Email/SMS</b><br/><small>SendGrid, Twilio</small>]
    end

    %% === CONEXIONES PRINCIPALES ===
    Users --> ClientApps
    ClientApps -->|HTTPS/REST/GraphQL| GW
    GW -->|GraphQL Federation| Microservices

    %% === CONEXIONES API GATEWAY A MICROSERVICIOS ===
    GW -->|Autentica<br/>REST/gRPC| M1
    GW -->|Consulta datos<br/>GraphQL| M2
    GW -->|Transferencias internas<br/>GraphQL| M3
    GW -->|Transferencias externas<br/>GraphQL| M4
    GW -->|Consulta histÃ³ricos<br/>GraphQL| M5
    GW -->|Registro auditorÃ­a<br/>GraphQL| M6
    GW -->|EnvÃ­a notificaciones<br/>GraphQL| M7
    GW -->|Gestiona archivos<br/>REST| M8

    %% === CONEXIONES MICROSERVICIOS A DATOS ===
    M1 -->|Usuarios/Sesiones<br/>SQL/TLS| DB1
    M1 -->|Cache sesiones<br/>Redis Protocol| DB4
    M1 -->|Secrets<br/>HTTPS/API| I2
    
    M2 -->|Datos cliente<br/>SQL/TLS| DB1
    M2 -->|Cache consultas<br/>Redis Protocol| DB4
    
    M3 -->|Transacciones<br/>SQL/TLS| DB1
    M3 -->|Eventos pagos<br/>Kafka Protocol| I1
    
    M4 -->|Transacciones<br/>SQL/TLS| DB1
    M4 -->|SAGA Orchestration<br/>Kafka Protocol| I1
    M4 -->|Transferencias ACH<br/>ISO 8583| E1
    
    M5 -->|Datos lectura<br/>SQL/TLS| DB2
    M5 -->|HistÃ³ricos<br/>MongoDB Protocol| DB3
    
    M6 -->|Consume eventos<br/>Kafka Protocol| I1
    M6 -->|Logs auditorÃ­a<br/>MongoDB Protocol| DB3
    
    M7 -->|Jobs notificaciones<br/>Bull Queue| I3
    M7 -->|Push notifications<br/>FCM API| E2
    M7 -->|Email/SMS<br/>HTTPS/API| E3
    
    M8 -->|Metadatos<br/>MongoDB Protocol| DB3
    M8 -->|Archivos<br/>Cloud Storage API| DB5
    M8 -->|Cache archivos<br/>Redis Protocol| DB4

    %% === ESTILOS CON COLORES PASTEL ===
    classDef title fill:#FCE4EC,stroke:#C2185B,stroke-width:2px,rx:15,ry:15
    classDef users fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px,rx:12,ry:12
    classDef clientApps fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,rx:12,ry:12
    classDef gateway fill:#FFF3E0,stroke:#FF9800,stroke-width:2px,rx:12,ry:12
    classDef microservices fill:#F3E5F5,stroke:#9C27B0,stroke-width:2px,rx:12,ry:12
    classDef coreBanking fill:#E0F2F1,stroke:#00897B,stroke-width:1px,rx:10,ry:10
    classDef dataServices fill:#FFEBEE,stroke:#D32F2F,stroke-width:1px,rx:10,ry:10
    classDef databases fill:#FFF9C4,stroke:#FBC02D,stroke-width:2px,rx:12,ry:12
    classDef infrastructure fill:#E8EAF6,stroke:#3F51B5,stroke-width:2px,rx:12,ry:12
    classDef external fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px,rx:12,ry:12
    classDef item fill:#FFFFFF,stroke:#666666,stroke-width:1px,rx:8,ry:8

    %% APLICAR ESTILOS ===
    class Title title
    class Users users
    class ClientApps clientApps
    class GW gateway
    class Microservices microservices
    class CoreBanking coreBanking
    class DataServices dataServices
    class Databases databases
    class Infrastructure infrastructure
    class External external
    class U1,U2,A1,A2,M1,M2,M3,M4,M5,M6,M7,M8,DB1,DB2,DB3,DB4,DB5,I1,I2,I3,E1,E2,E3 item

    </pre>

      <div class="legend">
        <h4>ğŸ”‘ Leyenda del Diagrama de Contenedores</h4>
        <ul>
          <li>
            <strong>Container (Azul):</strong> AplicaciÃ³n o servicio ejecutable
          </li>
          <li>
            <strong>ContainerDb (Azul con cilindro):</strong> Base de datos o
            almacenamiento
          </li>
          <li>
            <strong>System_Boundary (LÃ­nea punteada):</strong> LÃ­mite del
            sistema
          </li>
          <li>
            <strong>TecnologÃ­as indicadas:</strong> Stack tecnolÃ³gico de cada
            contenedor
          </li>
        </ul>
      </div>

      <div class="tech-stack">
        <div class="tech-item">
          <strong>Frontend</strong>
          React Native, React.js, TypeScript, Redux Toolkit
        </div>
        <div class="tech-item">
          <strong>Backend</strong>
          Node.js, Express, GraphQL, REST APIs
        </div>
        <div class="tech-item">
          <strong>Databases</strong>
          PostgreSQL 15, MongoDB 6, Redis 7
        </div>
        <div class="tech-item">
          <strong>Messaging</strong>
          Apache Kafka, Zookeeper
        </div>
        <div class="tech-item">
          <strong>Security</strong>
          OAuth 2.0, JWT, HashiCorp Vault
        </div>
        <div class="tech-item">
          <strong>Gateway</strong>
          Kong Gateway, NGINX, Rate Limiting
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- DIAGRAMA 3: COMPONENTES (C4 Level 3) -->
    <!-- ============================================ -->

    <h2>ğŸ”§ Diagrama 3: Componentes del MS-Pagos (C4 Level 3)</h2>

<div class="section">
        <strong>ğŸ¯ Audiencia:</strong> Desarrolladores, arquitectos de software
        que implementarÃ¡n el sistema<br />
        <strong>ğŸ“‹ PropÃ³sito:</strong> Detallar los componentes internos de un
        contenedor especÃ­fico (MS-Pagos), sus responsabilidades, patrones y
        comunicaciÃ³n<br />
        <strong>ğŸ” Nivel de detalle:</strong> Componentes internos, clases
        principales, patrones arquitectÃ³nicos, protocolos de seguridad
      </div>

    <div class="diagram">
      <div class="diagram-title">
        Arquitectura de Componentes - Microservicio de Pagos
      </div>      

      <pre class="mermaid">
flowchart TD
    %% === TÃTULO PRINCIPAL ===
    Title[<h2>ğŸ”§ MS-Pagos - Diagrama de Componentes</h2><br/><small>Microservicio de Procesamiento de Pagos con Event Sourcing</small>]

    %% === API GATEWAY ===
    GW[ğŸŒ<br/><b>API Gateway</b><br/><small>Apollo Gateway<br/>GraphQL Federation :8080</small>]

    %% === MICROSERVICIO PRINCIPAL - ARRIBA ===
    subgraph MSPagos[ğŸ’¸ MS-Pagos - Microservicio de Pagos]
        direction TB
        
        subgraph EntryLayer[ğŸ” Capa de Entrada & Seguridad]
            C1[ğŸ›¡ï¸<br/><b>Payment API Controller</b><br/><small>Express.js REST<br/>Valida JWT, Rate Limiting</small>]
            C2[ğŸ”‘<br/><b>Auth Middleware</b><br/><small>JWT Validator<br/>Verifica OAuth 2.0, Claims</small>]
            C12[ğŸ”’<br/><b>Encryption Service</b><br/><small>AES-256-GCM<br/>Cifrado datos sensibles</small>]
        end

        subgraph BusinessLayer[ğŸ’¼ LÃ³gica de Negocio Core]
            C3[âš™ï¸<br/><b>Transfer Service</b><br/><small>Business Logic<br/>Orquesta proceso transferencia</small>]
            C4[âœ…<br/><b>Validation Component</b><br/><small>Joi/Zod Schemas<br/>Valida montos, lÃ­mites diarios</small>]
            C5[ğŸ•µï¸<br/><b>Fraud Detection</b><br/><small>ML Model + Rules Engine<br/>Scoring riesgo, bloqueo automÃ¡tico</small>]
            C6[ğŸ”„<br/><b>Saga Orchestrator</b><br/><small>Saga Pattern<br/>Coordina transacciones distribuidas</small>]
        end

        subgraph DataLayer[ğŸ’¾ Capa de Datos & Eventos]
            C9[ğŸ’¾<br/><b>Transaction Repository</b><br/><small>TypeORM/Sequelize<br/>Acceso datos transaccionales</small>]
            C13[ğŸ“¨<br/><b>Event Box</b><br/><small>Outbox Pattern<br/>Garantiza entrega eventos atÃ³mica</small>]
            C14[ğŸ”„<br/><b>CQRS Projector</b><br/><small>Projection Handler<br/>Sincroniza datos lectura</small>]
            C10[ğŸ“¢<br/><b>Event Publisher</b><br/><small>Kafka Producer<br/>Publica eventos de dominio</small>]
            C11[ğŸ“<br/><b>Audit Logger</b><br/><small>Winston/Pino<br/>Registro compliance, auditorÃ­a</small>]
        end

        subgraph InfrastructureLayer[ğŸ› ï¸ Infraestructura & ComunicaciÃ³n]
            C7[âš¡<br/><b>Circuit Breaker</b><br/><small>Opossum/Hystrix<br/>Fail-fast, fallback logic</small>]
            C8[ğŸŒ<br/><b>ACH Network Client</b><br/><small>ISO 8583 Protocol<br/>Cliente red interbancaria</small>]
        end
    end

    %% === SISTEMAS EXTERNOS - HORIZONTALMENTE POR DEBAJO ===
    E2[ğŸ˜<br/><b>PostgreSQL</b><br/><small>PostgreSQL 15<br/>Base transaccional ACID</small>]
    E6[ğŸƒ<br/><b>MongoDB</b><br/><small>MongoDB 6<br/>Consultas optimizadas</small>]
    E3[ğŸ”´<br/><b>Redis</b><br/><small>Redis 7 Cluster<br/>Cache, locks distribuidos</small>]
    E4[ğŸ“¬<br/><b>Kafka</b><br/><small>Kafka 3.x + Zookeeper<br/>Event streaming, mensajerÃ­a</small>]
    E1[ğŸ’³<br/><b>Red ACH</b><br/><small>Sistema interbancario<br/>Transferencias externas</small>]
    E5[ğŸ”‘<br/><b>Vault</b><br/><small>HashiCorp Vault<br/>GestiÃ³n secrets, certificados</small>]

    %% === CONEXIONES PRINCIPALES ===
    GW -->|EnvÃ­a requests<br/>HTTPS/REST/GraphQL| C1

    %% === CONEXIONES CAPA DE ENTRADA ===
    C1 -->|Valida autenticaciÃ³n<br/>In-Memory| C2
    C1 -->|Procesa transferencia<br/>Function Call| C3

    %% === CONEXIONES LÃ“GICA DE NEGOCIO ===
    C3 -->|Valida datos entrada<br/>Function Call| C4
    C3 -->|Verifica patrones fraude<br/>Function Call| C5
    C3 -->|Inicia orquestaciÃ³n saga<br/>Function Call| C6
    C3 -->|Registra operaciÃ³n auditorÃ­a<br/>Function Call| C11

    %% === CONEXIONES SAGA ORCHESTRATOR ===
    C6 -->|Persiste transacciÃ³n<br/>SQL| C9
    C6 -->|Llama servicio externo<br/>Function Call| C7
    C6 -->|Publica eventos negocio<br/>Function Call| C10
    C6 -->|Cifra datos sensibles<br/>Function Call| C12

    %% === PATRÃ“N CQRS - FLUJO ESCRITURA ===
    C9 -->|Evento outbox transaccional<br/>SQL Transaction| C13

    %% === CONEXIONES INFRAESTRUCTURA ===
    C7 -->|Ejecuta transferencia protegida<br/>Function Call| C8

    %% === CONEXIONES A SISTEMAS EXTERNOS ===
    C2 -->|Obtiene public keys<br/>HTTPS/TLS 1.3| E5
    C9 -->|Guarda transacciÃ³n<br/>SQL/TLS 1.3| E2
    C9 -->|Usa locks distribuidos<br/>Redis Protocol| E3
    C13 -->|Publica evento consistente<br/>Kafka Protocol/SASL| E4
    E4 -->|Consume eventos<br/>Kafka Consumer| C14
    C14 -->|Sincroniza datos lectura<br/>Bulk Operations| E6
    C14 -->|Actualiza cache consultas<br/>Redis Protocol| E3
    C8 -->|EnvÃ­a transacciÃ³n segura<br/>ISO 8583/TLS| E1
    C10 -->|Publica mensaje eventos<br/>Kafka Protocol/SASL| E4
    C11 -->|EnvÃ­a log auditorÃ­a<br/>Kafka Protocol| E4
    C12 -->|Obtiene keys cifrado<br/>HTTPS/TLS 1.3| E5
    C5 -->|Lee scoring cache<br/>Redis Protocol| E3

    %% === ESTILOS CON COLORES PASTEL ===
    classDef title fill:#FCE4EC,stroke:#C2185B,stroke-width:2px,rx:15,ry:15
    classDef gateway fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,rx:12,ry:12
    classDef msPagos fill:#F3E5F5,stroke:#9C27B0,stroke-width:2px,rx:12,ry:12
    classDef entryLayer fill:#E8F5E9,stroke:#4CAF50,stroke-width:1px,rx:10,ry:10
    classDef businessLayer fill:#FFF3E0,stroke:#FF9800,stroke-width:1px,rx:10,ry:10
    classDef dataLayer fill:#E0F2F1,stroke:#00897B,stroke-width:1px,rx:10,ry:10
    classDef infrastructureLayer fill:#FFEBEE,stroke:#D32F2F,stroke-width:1px,rx:10,ry:10
    classDef externalSystems fill:#FFF9C4,stroke:#FBC02D,stroke-width:2px,rx:8,ry:8
    classDef component fill:#FFFFFF,stroke:#666666,stroke-width:1px,rx:8,ry:8

    %% APLICAR ESTILOS ===
    class Title title
    class GW gateway
    class MSPagos msPagos
    class EntryLayer entryLayer
    class BusinessLayer businessLayer
    class DataLayer dataLayer
    class InfrastructureLayer infrastructureLayer
    class C1,C2,C3,C4,C5,C6,C7,C8,C9,C10,C11,C12,C13,C14 component
    class E1,E2,E3,E4,E5,E6 externalSystems

    %% ESTILOS DE LÃNEAS ===
    linkStyle 0 stroke:#1976D2,stroke-width:2px
    linkStyle 1,2 stroke:#4CAF50,stroke-width:1.5px
    linkStyle 3,4,5,6 stroke:#FF9800,stroke-width:1.5px
    linkStyle 7,8,9,10 stroke:#00897B,stroke-width:1.5px
    linkStyle 11 stroke:#4CAF50,stroke-width:2px
    linkStyle 12 stroke:#D32F2F,stroke-width:1.5px
    %% Conexiones a sistemas externos
    linkStyle 13 stroke:#9C27B0,stroke-width:1.5px
    linkStyle 14 stroke:#0288D1,stroke-width:1.5px
    linkStyle 15 stroke:#FBC02D,stroke-width:1.5px
    linkStyle 16 stroke:#7B1FA2,stroke-width:1.5px
    linkStyle 17,18 stroke:#1976D2,stroke-width:1.5px
    linkStyle 19 stroke:#E64A19,stroke-width:1.5px
    linkStyle 20,21 stroke:#7B1FA2,stroke-width:1.5px
    linkStyle 22 stroke:#9C27B0,stroke-width:1.5px
    linkStyle 23 stroke:#FBC02D,stroke-width:1.5px

    </pre>
<!-- Diagrama -->
      <div class="legend">
        <h4>ğŸ”‘ Leyenda del Diagrama de Componentes</h4>
        <ul>
          <li>
            <strong>Component (Verde):</strong> Componente interno del
            contenedor
          </li>
          <li>
            <strong>Relaciones:</strong> Indican protocolo y tipo de
            comunicaciÃ³n
          </li>
          <li>
            <strong>Patrones destacados:</strong> Circuit Breaker, Saga, Event
            Publishing
          </li>
        </ul>
      </div>

      <div class="info-box">
        <h4>ğŸ—ï¸ Patrones ArquitectÃ³nicos Implementados en MS-Pagos</h4>
        <ul>
          <li>
            <strong>Circuit Breaker:</strong> ProtecciÃ³n contra fallos en
            cascada con llamadas externas (ACH Network)
          </li>
          <li>
            <strong>Saga Pattern:</strong> Transacciones distribuidas con
            compensaciones automÃ¡ticas
          </li>
          <li>
            <strong>Event Sourcing:</strong> PublicaciÃ³n de eventos para
            auditorÃ­a y sincronizaciÃ³n
          </li>
          <li>
            <strong>Repository Pattern:</strong> AbstracciÃ³n del acceso a datos
          </li>
          <li>
            <strong>Middleware Pattern:</strong> AutenticaciÃ³n y validaciÃ³n como
            middlewares reutilizables
          </li>
          <li>
            <strong>Retry con Exponential Backoff:</strong> En ACH Client para
            manejar fallos temporales
          </li>
          <li>
            <strong>Encryption at Rest:</strong> Datos sensibles cifrados con
            AES-256-GCM
          </li>
        </ul>
      </div>

      <div class="info-box">
        <h4>ğŸ” Seguridad Implementada</h4>
        <ul>
          <li>
            <strong>OAuth 2.0 + JWT:</strong> AutenticaciÃ³n y autorizaciÃ³n en
            Auth Middleware
          </li>
          <li>
            <strong>TLS 1.3:</strong> Todas las comunicaciones cifradas
            (PostgreSQL, ACH Network, Vault)
          </li>
          <li>
            <strong>SASL:</strong> AutenticaciÃ³n en Kafka para event publishing
          </li>
          <li>
            <strong>AES-256-GCM:</strong> Cifrado de datos sensibles en reposo
          </li>
          <li>
            <strong>Secret Management:</strong> Claves rotadas automÃ¡ticamente
            desde Vault
          </li>
          <li>
            <strong>Rate Limiting:</strong> En API Controller para prevenir
            abuse
          </li>
          <li>
            <strong>Input Validation:</strong> Schemas estrictos con Joi/Zod
          </li>
          <li>
            <strong>Audit Logging:</strong> Registro completo de todas las
            operaciones para compliance
          </li>
        </ul>
      </div>

      <div class="info-box">
        <h4>â˜ï¸ Componentes Cloud Utilizados</h4>
        <ul>
          <li>
            <strong>Kubernetes (k3s/EKS):</strong> OrquestaciÃ³n de contenedores
            con auto-scaling (HPA)
          </li>
          <li>
            <strong>Managed PostgreSQL (RDS/CloudSQL):</strong> Alta
            disponibilidad con rÃ©plicas multi-AZ
          </li>
          <li>
            <strong>Managed Redis (ElastiCache):</strong> Cluster mode para
            distributed locks
          </li>
          <li>
            <strong>Managed Kafka (MSK/Confluent):</strong> Event streaming con
            3+ brokers
          </li>
          <li>
            <strong>AWS S3/Backblaze:</strong> Backup de transacciones y logs de
            auditorÃ­a
          </li>
          <li>
            <strong>CloudWatch/Prometheus:</strong> MÃ©tricas de performance y
            alertas
          </li>
          <li>
            <strong>AWS Secrets Manager/Vault:</strong> RotaciÃ³n automÃ¡tica de
            credenciales
          </li>
        </ul>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- RESUMEN Y CONCLUSIONES -->
    <!-- ============================================ -->

    <div class="diagram-container">
      <h2 >
        âœ… Resumen de Diagramas C4
      </h2>

      <div class="info-box">
        <h4>ğŸ“Š Tres Niveles de AbstracciÃ³n</h4>
        <p>
          Los diagramas C4 presentados siguen la metodologÃ­a oficial de Simon
          Brown, proporcionando diferentes niveles de zoom para diferentes
          audiencias:
        </p>

        <table style="width: 100%; border-collapse: collapse; margin: 20px 0">
          <thead>
            <tr style="background: #3498db; color: white">
              <th style="padding: 12px; text-align: left">Nivel</th>
              <th style="padding: 12px; text-align: left">Diagrama</th>
              <th style="padding: 12px; text-align: left">Audiencia</th>
              <th style="padding: 12px; text-align: left">Enfoque</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom: 1px solid #ecf0f1">
              <td style="padding: 12px"><strong>C4 Level 1</strong></td>
              <td style="padding: 12px">Contexto</td>
              <td style="padding: 12px">Stakeholders, Gerencia</td>
              <td style="padding: 12px">
                Sistema en su entorno, actores, sistemas externos
              </td>
            </tr>
            <tr style="border-bottom: 1px solid #ecf0f1">
              <td style="padding: 12px"><strong>C4 Level 2</strong></td>
              <td style="padding: 12px">Contenedores</td>
              <td style="padding: 12px">Arquitectos, Tech Leads</td>
              <td style="padding: 12px">
                Apps, servicios, bases de datos, tecnologÃ­as
              </td>
            </tr>
            <tr>
              <td style="padding: 12px"><strong>C4 Level 3</strong></td>
              <td style="padding: 12px">Componentes</td>
              <td style="padding: 12px">Desarrolladores</td>
              <td style="padding: 12px">
                Componentes internos, patrones, seguridad
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="info-box">
        <h4>ğŸ¯ Decisiones ArquitectÃ³nicas Clave Visualizadas</h4>
        <ul>
          <li>
            âœ… <strong>Arquitectura de Microservicios:</strong> 6 microservicios
            independientes y especializados
          </li>
          <li>
            âœ… <strong>Event-Driven Architecture:</strong> Kafka como backbone
            para comunicaciÃ³n asÃ­ncrona
          </li>
          <li>
            âœ… <strong>API Gateway Pattern:</strong> Punto de entrada Ãºnico con
            autenticaciÃ³n centralizada
          </li>
          <li>
            âœ… <strong>CQRS:</strong> SeparaciÃ³n de lecturas (replicas) y
            escrituras (primary DB)
          </li>
          <li>
            âœ… <strong>Circuit Breaker:</strong> ProtecciÃ³n contra fallos en
            cascada
          </li>
          <li>
            âœ… <strong>Saga Pattern:</strong> Transacciones distribuidas con
            compensaciones
          </li>
          <li>
            âœ… <strong>Multi-Database:</strong> PostgreSQL (transaccional) +
            MongoDB (histÃ³ricos) + Redis (cachÃ©)
          </li>
          <li>
            âœ… <strong>Security by Design:</strong> OAuth 2.0, TLS 1.3,
            encryption at rest, secrets management
          </li>
        </ul>
      </div>

      <div class="info-box">
        <h4>ğŸ“ Convenciones C4 Seguidas</h4>
        <ul>
          <li>
            âœ… NotaciÃ³n estÃ¡ndar de elementos (Person, System, Container,
            Component)
          </li>
          <li>
            âœ… DistinciÃ³n clara entre sistemas internos y externos (System_Ext)
          </li>
          <li>âœ… Uso de System_Boundary para delimitar el sistema</li>
          <li>âœ… Relaciones con descripciÃ³n y protocolo</li>
          <li>âœ… TecnologÃ­as especificadas en cada contenedor/componente</li>
          <li>âœ… Colores estÃ¡ndar segÃºn el modelo C4</li>
          <li>âœ… Tres niveles de abstracciÃ³n bien diferenciados</li>
        </ul>
      </div>

      <div class="legend">
        <h4>ğŸ”— Referencias</h4>
        <ul>
          <li>
            ğŸ“– <strong>C4 Model:</strong>
            <a href="https://c4model.info/" target="_blank"
              >https://c4model.info/</a
            >
          </li>
          <li>
            ğŸ“– <strong>C4 Architecture:</strong> Simon Brown - Visualising
            Software Architecture
          </li>
        </ul>
      </div>
    </div>

    <script>
      mermaid.initialize({
        startOnLoad: true,
        theme: "default",
        c4: {
          diagramMarginX: 50,
          diagramMarginY: 10,
          c4ShapeMargin: 50,
          c4ShapePadding: 20,
          width: 216,
          height: 60,
          boxMargin: 10,
          useMaxWidth: true,
        },
      });
    </script>
    <script src="mermaid.min.js"></script>
    <script src="panzoom.min.js"></script>
    <script src="app.js"></script>
  </body>
</html>
