<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CapÃ­tulo 11 - Alta Disponibilidad y Resiliencia del Sistema</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="nav-header">
      <h2>CapÃ­tulo 11: Alta Disponibilidad y Resiliencia del Sistema</h2>
      <div class="nav-buttons">
        <a href="capitulo_10.html" class="nav-btn">â† Anterior</a>
        <a href="index.html" class="nav-btn">Ãndice</a>
        <a href="capitulo_12.html" class="nav-btn">Siguiente â†’</a>
      </div>
    </div>

    <h1>11. ALTA DISPONIBILIDAD Y RESILIENCIA DEL SISTEMA</h1>

    <h2>11.1 Objetivos de Disponibilidad (SLA)</h2>

    <div class="section">
      <table>
        <thead>
          <tr>
            <th>MÃ©trica</th>
            <th>Objetivo</th>
            <th>CÃ¡lculo Anual</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Uptime</strong></td>
            <td>99.9% (Three Nines)</td>
            <td>8.76 horas downtime/aÃ±o</td>
          </tr>
          <tr>
            <td><strong>RTO</strong> (Recovery Time Objective)</td>
            <td>&lt; 15 minutos</td>
            <td>Tiempo mÃ¡ximo de recuperaciÃ³n</td>
          </tr>
          <tr>
            <td><strong>RPO</strong> (Recovery Point Objective)</td>
            <td>&lt; 5 minutos</td>
            <td>PÃ©rdida mÃ¡xima de datos</td>
          </tr>
          <tr>
            <td><strong>Latencia API</strong></td>
            <td>&lt; 200ms (p95)</td>
            <td>95% de requests bajo 200ms</td>
          </tr>
          <tr>
            <td><strong>Error Rate</strong></td>
            <td>&lt; 0.1%</td>
            <td>MÃ¡ximo 1 error por 1000 requests</td>
          </tr>
        </tbody>
      </table>

      <div class="note">
        <strong>99.9% Uptime significa:</strong>
        <ul>
          <li>8.76 horas de downtime permitido por aÃ±o</li>
          <li>43.8 minutos por mes</li>
          <li>10.1 minutos por semana</li>
          <li>1.44 minutos por dÃ­a</li>
        </ul>
      </div>
    </div>

    <h2>11.2 Estrategias de Alta Disponibilidad</h2>

    <div class="section">
      <h3>11.2.1 RÃ©plicas de Microservicios</h3>

      <ul>
        <li>
          <strong>MÃ­nimo 2 rÃ©plicas en producciÃ³n</strong> (hasta 3 para
          servicios crÃ­ticos)
        </li>
        <li>
          <strong>Desplegadas en diferentes nodos</strong> (anti-affinity rules
          en K8s)
        </li>
        <li><strong>Health checks continuos</strong> cada 10 segundos</li>
        <li><strong>RecreaciÃ³n automÃ¡tica</strong> de pods fallidos</li>
        <li><strong>Rolling updates</strong> sin downtime (20% max surge)</li>
      </ul>

      <h3>11.2.2 RÃ©plicas de Bases de Datos</h3>

      <div class="diagram">
        <div class="diagram-title">
          PostgreSQL Master-Replica con Failover AutomÃ¡tico
        </div>
        <pre class="mermaid">
graph TB
    %% === PRIMARY DATABASE ===
    subgraph PRIMARY[ğŸŸ¢ Primary Database]
        P[<b>Primary<br/> Read+Write </b><br/>Active Master]
    end

    %% === REPLICA DATABASES ===
    subgraph REPLICAS[ğŸ”µ Read Replicas]
        R1[<b>Replica 1</b><br/>Read-only<br/>ğŸ“ AZ-A]
        R2[<b>Replica 2</b><br/>Read-only<br/>ğŸ“ AZ-B]
        R3[<b>Replica 3</b><br/>Read-only<br/>ğŸ“ AZ-C]
    end

    %% === FAILOVER MANAGEMENT ===
    FAILOVER[ğŸ”„ Patroni/Stolon<br/>Automatic Failover]

    %% === CONNECTIONS ===
    P -->|Streaming Replication<br/> AsÃ­ncrona | R1
    P -->|Streaming Replication<br/> AsÃ­ncrona | R2
    P -->|Streaming Replication<br/> AsÃ­ncrona | R3
    
    FAILOVER -.-> P
    FAILOVER -.-> R1
    FAILOVER -.-> R2
    FAILOVER -.-> R3

    %% === STYLES ===
    classDef primary fill:#E8F5E9,stroke:#4CAF50,stroke-width:3px,rx:15,ry:15
    classDef replica fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,rx:12,ry:12
    classDef failover fill:#FFF3E0,stroke:#FF9800,stroke-width:2px,rx:10,ry:10
    classDef connection stroke:#1976D2,stroke-width:2px
    classDef failoverConnection stroke:#FF9800,stroke-width:2px,stroke-dasharray:5 5

    class P primary
    class R1,R2,R3 replica
    class FAILOVER failover

    linkStyle 0,1,2 stroke:#1976D2,stroke-width:2px
    linkStyle 3,4,5,6 stroke:#FF9800,stroke-width:2px,stroke-dasharray:5 5

Failover AutomÃ¡tico:
1. Primary cae
2. Patroni detecta (5 segundos)
3. Elige nueva Primary (Replica con menos lag)
4. PromociÃ³n automÃ¡tica (10 segundos)
5. Actualiza DNS/Endpoints
6. Total: &lt; 20 segundos de interrupciÃ³n
        </pre>
      </div>

      <h3>11.2.3 Circuit Breaker Pattern</h3>

      <div class="diagram">
        <div class="diagram-title">Estados del Circuit Breaker</div>
        <pre>
Estado Normal (CLOSED):
  Request â†’ Servicio âœ“
  â””â”€â–º Se monitorean fallos

Estado Abierto (OPEN):
  Request â†’ Circuit Breaker â†’ Error inmediato
  â””â”€â–º NO se llama al servicio (fail-fast)
  â””â”€â–º Espera 30 segundos â†’ HALF_OPEN

Estado Semi-Abierto (HALF_OPEN):
  Request â†’ Circuit Breaker â†’ Intenta 1 request de prueba
  â”œâ”€â–º Si Ã©xito â†’ CLOSED (vuelve a normal)
  â””â”€â–º Si falla â†’ OPEN (espera otros 30s)
        </pre>
      </div>

      <table>
        <thead>
          <tr>
            <th>Servicio</th>
            <th>Threshold</th>
            <th>Timeout</th>
            <th>Reset Time</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>MS-Datos-Cliente</td>
            <td>50% error en 10 req</td>
            <td>5s</td>
            <td>30s</td>
          </tr>
          <tr>
            <td>MS-Pagos</td>
            <td>60% error en 20 req</td>
            <td>10s</td>
            <td>60s</td>
          </tr>
          <tr>
            <td>ACH Network (externo)</td>
            <td>40% error en 5 req</td>
            <td>15s</td>
            <td>120s</td>
          </tr>
          <tr>
            <td>MS-Notificaciones</td>
            <td>70% error en 50 req</td>
            <td>3s</td>
            <td>20s</td>
          </tr>
        </tbody>
      </table>

      <h3>11.2.4 Retry con Exponential Backoff + Jitter</h3>

      <pre>
Intento 1: Inmediato
  â”œâ”€ Falla â†’ Esperar 1s + random(0-200ms)
  â”‚
Intento 2: DespuÃ©s de ~1s
  â”œâ”€ Falla â†’ Esperar 2s + random(0-400ms)
  â”‚
Intento 3: DespuÃ©s de ~2s
  â”œâ”€ Falla â†’ Esperar 4s + random(0-800ms)
  â”‚
Intento 4: DespuÃ©s de ~4s
  â”œâ”€ Falla â†’ Esperar 8s + random(0-1600ms)
  â”‚
Intento 5: DespuÃ©s de ~8s
  â””â”€ Falla â†’ Error definitivo, ejecutar compensaciÃ³n

Jitter (ruido aleatorio): Previene "thundering herd"
cuando mÃºltiples clientes reintentan simultÃ¡neamente
    </pre
      >

      <h3>11.2.5 Graceful Degradation</h3>

      <table>
        <thead>
          <tr>
            <th>Escenario</th>
            <th>Servicio Afectado</th>
            <th>Comportamiento Degradado</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>MS-HistÃ³ricos caÃ­do</td>
            <td>Consulta movimientos</td>
            <td>
              Mostrar Ãºltimos 5 desde cachÃ© + mensaje "Datos de hace 15 min"
            </td>
          </tr>
          <tr>
            <td>ACH Network lento</td>
            <td>Transferencias interbancarias</td>
            <td>Mostrar "Procesando, recibirÃ¡s notificaciÃ³n" (asÃ­ncrono)</td>
          </tr>
          <tr>
            <td>MS-Notificaciones saturado</td>
            <td>EnvÃ­o de emails</td>
            <td>Queue notifications, enviar cuando se recupere</td>
          </tr>
          <tr>
            <td>Redis caÃ­do</td>
            <td>CachÃ© de sesiones</td>
            <td>Leer directo de PostgreSQL (mÃ¡s lento pero funcional)</td>
          </tr>
          <tr>
            <td>Firebase caÃ­do</td>
            <td>Push notifications</td>
            <td>Fallback a SMS o solo email</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h2>11.3 Disaster Recovery</h2>

    <div class="section">
      <h3>11.3.1 Estrategia de Backup</h3>

      <table>
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Frecuencia</th>
            <th>RetenciÃ³n</th>
            <th>Storage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Full Backup</strong></td>
            <td>Semanal (Domingo 2am)</td>
            <td>3 meses</td>
            <td>S3 Glacier</td>
          </tr>
          <tr>
            <td><strong>Incremental</strong></td>
            <td>Diario (2am)</td>
            <td>30 dÃ­as</td>
            <td>S3 Standard</td>
          </tr>
          <tr>
            <td><strong>Transaction Logs (WAL)</strong></td>
            <td>Continuo</td>
            <td>7 dÃ­as</td>
            <td>S3 Standard</td>
          </tr>
          <tr>
            <td><strong>Snapshots</strong></td>
            <td>Cada 6 horas</td>
            <td>48 horas</td>
            <td>EBS Snapshots</td>
          </tr>
        </tbody>
      </table>

      <h3>11.3.2 Plan de RecuperaciÃ³n ante Desastres</h3>

      <table>
        <thead>
          <tr>
            <th>Escenario</th>
            <th>RTO</th>
            <th>RPO</th>
            <th>Procedimiento</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>1 microservicio caÃ­do</strong></td>
            <td>&lt;2 min</td>
            <td>0</td>
            <td>K8s restart automÃ¡tico del pod</td>
          </tr>
          <tr>
            <td><strong>1 nodo caÃ­do</strong></td>
            <td>&lt;5 min</td>
            <td>0</td>
            <td>K8s reschedula pods en otros nodos</td>
          </tr>
          <tr>
            <td><strong>Zona AZ completa caÃ­da</strong></td>
            <td>&lt;5 min</td>
            <td>0</td>
            <td>Failover automÃ¡tico a otra AZ (multi-AZ deployment)</td>
          </tr>
          <tr>
            <td><strong>RegiÃ³n completa caÃ­da</strong></td>
            <td>&lt;15 min</td>
            <td>&lt;5 min</td>
            <td>Failover manual a regiÃ³n secundaria</td>
          </tr>
          <tr>
            <td><strong>CorrupciÃ³n de BD</strong></td>
            <td>&lt;30 min</td>
            <td>&lt;5 min</td>
            <td>PITR restore desde WAL logs</td>
          </tr>
          <tr>
            <td><strong>Ransomware</strong></td>
            <td>&lt;1 hora</td>
            <td>&lt;1 hora</td>
            <td>Restore desde backup offline (air-gapped)</td>
          </tr>
        </tbody>
      </table>

      <h3>11.3.3 Database PITR (Point-in-Time Recovery)</h3>

      <div class="diagram">
        <div class="diagram-title">Estrategia PITR PostgreSQL</div>
        <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      POSTGRESQL PITR STRATEGY                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  Base Backup (Full): Domingo 2am               â”‚
â”‚  â”‚                                             â”‚
â”‚  â”œâ”€â–º Stored in S3 Glacier                     â”‚
â”‚  â”œâ”€â–º Compressed with pg_dump                  â”‚
â”‚  â””â”€â–º Retention: 90 dÃ­as                       â”‚
â”‚                                                â”‚
â”‚  WAL (Write-Ahead Logs): Continuo             â”‚
â”‚  â”‚                                             â”‚
â”‚  â”œâ”€â–º Archived every 16MB or 5 minutes         â”‚
â”‚  â”œâ”€â–º Stored in S3 Standard                    â”‚
â”‚  â”œâ”€â–º Retention: 30 dÃ­as                       â”‚
â”‚  â””â”€â–º Enable PITR a cualquier momento          â”‚
â”‚                                                â”‚
â”‚  Procedimiento de RecuperaciÃ³n:                â”‚
â”‚  â”œâ”€â–º 1. Restaurar Full Backup mÃ¡s reciente    â”‚
â”‚  â”œâ”€â–º 2. Aplicar WAL logs hasta punto deseado  â”‚
â”‚  â”œâ”€â–º 3. Tiempo de recuperaciÃ³n: 15-30 min     â”‚
â”‚  â””â”€â–º 4. PÃ©rdida mÃ¡xima de datos: 5 minutos    â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </pre>
      </div>
    </div>

    <h2>11.4 Monitoreo y Alertas</h2>

    <div class="section">
      <h3>11.4.1 Sistema de Alertas Proactivo</h3>

      <table>
        <thead>
          <tr>
            <th>Alerta</th>
            <th>Umbral</th>
            <th>AcciÃ³n</th>
            <th>Canal</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>CPU &gt; 80%</td>
            <td>5 min consecutivos</td>
            <td>Escalar pods automÃ¡ticamente</td>
            <td>Slack + Email</td>
          </tr>
          <tr>
            <td>Error Rate &gt; 1%</td>
            <td>2 minutos</td>
            <td>InvestigaciÃ³n inmediata</td>
            <td>PagerDuty</td>
          </tr>
          <tr>
            <td>Latencia &gt; 500ms</td>
            <td>p95 por 3 min</td>
            <td>Revisar cuellos de botella</td>
            <td>Slack</td>
          </tr>
          <tr>
            <td>Disco &gt; 85%</td>
            <td>InstantÃ¡neo</td>
            <td>Limpiar logs antiguos</td>
            <td>Email</td>
          </tr>
          <tr>
            <td>Pod restart loop</td>
            <td>3 restarts en 5 min</td>
            <td>Alerta crÃ­tica</td>
            <td>PagerDuty</td>
          </tr>
          <tr>
            <td>Backup fallido</td>
            <td>Cualquier fallo</td>
            <td>AcciÃ³n inmediata</td>
            <td>Email + SMS</td>
          </tr>
        </tbody>
      </table>

      <h3>11.4.2 Dashboard de Operaciones en Grafana</h3>

      <ul>
        <li><strong>Estado de salud</strong> de todos los microservicios</li>
        <li>
          <strong>MÃ©tricas de negocio:</strong> Transacciones/hora, monto total
        </li>
        <li><strong>Latencias por endpoint:</strong> p50, p95, p99</li>
        <li><strong>Tasa de errores:</strong> Por servicio y global</li>
        <li><strong>Uso de recursos:</strong> CPU, RAM, Disco por pod</li>
        <li>
          <strong>Salud de BD y cachÃ©:</strong> Conexiones, latencia, hit rate
        </li>
      </ul>
    </div>

    <h2>11.5 RESILIENCIA DEL SISTEMA</h2>

    <div class="section">
      <p>
        La resiliencia es la capacidad del sistema para
        <strong>resistir, adaptarse y recuperarse</strong> de fallos,
        disrupciones y cambios en la demanda, manteniendo un nivel aceptable de
        servicio.
      </p>

      <div class="diagram">
        <div class="diagram-title">Tres Pilares de Resiliencia</div>
        <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RESILIENCIA DEL SISTEMA                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ RESISTENCIA  â”‚  â”‚  ADAPTACIÃ“N  â”‚  â”‚ RECUPERACIÃ“Nâ”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚             â”‚  â”‚
â”‚  â”‚ â€¢ Circuit    â”‚  â”‚ â€¢ HPA/VPA    â”‚  â”‚ â€¢ Self-     â”‚  â”‚
â”‚  â”‚   Breaker    â”‚  â”‚ â€¢ Queue-basedâ”‚  â”‚   Healing   â”‚  â”‚
â”‚  â”‚ â€¢ Bulkhead   â”‚  â”‚   Leveling   â”‚  â”‚ â€¢ Auto      â”‚  â”‚
â”‚  â”‚ â€¢ Retry +    â”‚  â”‚ â€¢ Adaptive   â”‚  â”‚   Rollback  â”‚  â”‚
â”‚  â”‚   Backoff    â”‚  â”‚   Rate Limit â”‚  â”‚ â€¢ PITR      â”‚  â”‚
â”‚  â”‚ â€¢ Timeouts   â”‚  â”‚ â€¢ Priority   â”‚  â”‚ â€¢ Chaos     â”‚  â”‚
â”‚  â”‚ â€¢ Degradationâ”‚  â”‚   Queues     â”‚  â”‚   Engineer. â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </pre>
      </div>

      <h3>11.5.1 RESISTENCIA - Tolerancia a Fallos Parciales</h3>

      <h4>A) Bulkhead Pattern - Aislamiento de Recursos</h4>

      <div class="diagram">
        <div class="diagram-title">
          Aislamiento de Recursos por Tipo de OperaciÃ³n
        </div>
        <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MS-PAGOS (Ejemplo)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Thread Pool        â”‚       â”‚  Thread Pool     â”‚   â”‚
â”‚  â”‚  CONSULTAS          â”‚       â”‚  TRANSFERENCIAS  â”‚   â”‚
â”‚  â”‚                     â”‚       â”‚                  â”‚   â”‚
â”‚  â”‚  â€¢ 20 threads       â”‚       â”‚  â€¢ 10 threads    â”‚   â”‚
â”‚  â”‚  â€¢ Timeout: 5s      â”‚       â”‚  â€¢ Timeout: 30s  â”‚   â”‚
â”‚  â”‚  â€¢ Queue: 100       â”‚       â”‚  â€¢ Queue: 50     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                            â”‚             â”‚
â”‚             â–¼                            â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Connection Pool    â”‚       â”‚  Connection Pool â”‚   â”‚
â”‚  â”‚  READ REPLICA       â”‚       â”‚  PRIMARY DB      â”‚   â”‚
â”‚  â”‚  50 connections     â”‚       â”‚  20 connections  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Thread Pool - NOTIFICACIONES                 â”‚    â”‚
â”‚  â”‚  â€¢ 5 threads                                  â”‚    â”‚
â”‚  â”‚  â€¢ No crÃ­tico, puede fallar sin afectar core  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </pre>
      </div>

      <p>
        <strong>Beneficio:</strong> Si notificaciones fallan o se saturan, NO
        afecta las transferencias. Aislamiento total de recursos crÃ­ticos vs
        no-crÃ­ticos.
      </p>

      <h3>11.5.2 ADAPTACIÃ“N - Escalabilidad DinÃ¡mica</h3>

      <h4>A) Queue-Based Load Leveling</h4>

      <div class="diagram">
        <div class="diagram-title">AbsorciÃ³n de Picos con Colas</div>
        <pre>
TrÃ¡fico Variable
     â”‚
     â”‚  Peak: 10,000 req/s
     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚         â”‚ 
     â”‚  Normal:â”‚ 2,000 req/s
     â”‚  â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚         â”‚
     â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   KAFKA QUEUE      â”‚
â”‚                    â”‚
â”‚  Buffer: 1M msgs   â”‚
â”‚  TTL: 10 minutes   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Consume at sustainable rate
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Workers Pool      â”‚
â”‚                    â”‚
â”‚  Process: 3K req/s â”‚
â”‚  Consistent rate   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Beneficio: Sistema procesa a ritmo constante
Ahorro: 50-60% en costos vs aprovisionar para pico
        </pre>
      </div>

      <h4>B) Rate Limiting Adaptativo</h4>

      <table>
        <thead>
          <tr>
            <th>Carga del Sistema</th>
            <th>Rate Limit Ajustado</th>
            <th>AcciÃ³n</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Baja (&lt;30%)</td>
            <td>150 req/min (â†‘ 50%)</td>
            <td>Permitir mÃ¡s requests</td>
          </tr>
          <tr>
            <td>Normal (30-75%)</td>
            <td>100 req/min (base)</td>
            <td>Rate limit estÃ¡ndar</td>
          </tr>
          <tr>
            <td>Alta (75-90%)</td>
            <td>75 req/min (â†“ 25%)</td>
            <td>Reducir carga</td>
          </tr>
          <tr>
            <td>CrÃ­tica (&gt;90%)</td>
            <td>50 req/min (â†“ 50%)</td>
            <td>Proteger sistema</td>
          </tr>
        </tbody>
      </table>

      <h4>C) Priority Queues</h4>

      <table>
        <thead>
          <tr>
            <th>Prioridad</th>
            <th>Tipo de OperaciÃ³n</th>
            <th>Workers</th>
            <th>SLA</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>CRITICAL</strong></td>
            <td>Transferencias &gt;$10K, NÃ³mina</td>
            <td>10</td>
            <td>&lt;5s</td>
          </tr>
          <tr>
            <td><strong>HIGH</strong></td>
            <td>Transferencias normales</td>
            <td>5</td>
            <td>&lt;30s</td>
          </tr>
          <tr>
            <td><strong>NORMAL</strong></td>
            <td>Consultas, notificaciones</td>
            <td>3</td>
            <td>&lt;2min</td>
          </tr>
          <tr>
            <td><strong>LOW</strong></td>
            <td>Reportes, analytics</td>
            <td>1</td>
            <td>Best-effort</td>
          </tr>
        </tbody>
      </table>

      <h3>11.5.3 RECUPERACIÃ“N - Auto-Healing</h3>

      <h4>A) Self-Healing en Kubernetes</h4>

      <ol>
        <li>
          <strong>Liveness Probe Falla:</strong> K8s mata y recrea el pod
          automÃ¡ticamente (&lt;30s)
        </li>
        <li>
          <strong>Readiness Probe Falla:</strong> Pod removido del balanceador
          hasta recuperarse
        </li>
        <li>
          <strong>Node Falla:</strong> K8s reschedula todos los pods en otros
          nodos (&lt;5min)
        </li>
        <li>
          <strong>OOM (Out of Memory):</strong> VPA ajusta lÃ­mites y recrea con
          mÃ¡s memoria
        </li>
      </ol>

      <h4>B) Automated Rollback</h4>

      <table>
        <thead>
          <tr>
            <th>MÃ©trica</th>
            <th>Threshold</th>
            <th>AcciÃ³n</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Error rate</td>
            <td>+50% vs baseline</td>
            <td>Rollback inmediato (&lt;60s)</td>
          </tr>
          <tr>
            <td>Latencia p95</td>
            <td>+100ms vs baseline</td>
            <td>Rollback inmediato</td>
          </tr>
          <tr>
            <td>CPU usage</td>
            <td>&gt;90% sostenido</td>
            <td>Rollback en 2 min</td>
          </tr>
          <tr>
            <td>5xx errors</td>
            <td>&gt;10 en 1 minuto</td>
            <td>Rollback inmediato</td>
          </tr>
        </tbody>
      </table>

      <h4>C) Chaos Engineering</h4>

      <ul>
        <li>
          <strong>Game Days (Mensual):</strong> Simular fallo de nodo, inyectar
          latencia, validar auto-recuperaciÃ³n
        </li>
        <li>
          <strong>Chaos Monkey (ProducciÃ³n):</strong> Mata 1 pod aleatorio cada
          hora (horario no-peak 2am-6am)
        </li>
        <li>
          <strong>Latency Monkey:</strong> Inyecta 200-500ms latencia en 5% de
          requests aleatoriamente
        </li>
        <li>
          <strong>Failure Injection (Staging):</strong> Simular caÃ­da de Redis,
          Kafka, ACH network
        </li>
      </ul>

      <h3>11.5.4 MÃ©tricas de Resiliencia</h3>

      <table>
        <thead>
          <tr>
            <th>MÃ©trica</th>
            <th>Objetivo</th>
            <th>Alertas</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>MTBF</strong> (Mean Time Between Failures)</td>
            <td>&gt;720 horas (30 dÃ­as)</td>
            <td>&lt;480 horas</td>
          </tr>
          <tr>
            <td><strong>MTTR</strong> (Mean Time To Recover)</td>
            <td>&lt;15 minutos</td>
            <td>&gt;30 minutos</td>
          </tr>
          <tr>
            <td><strong>Uptime</strong></td>
            <td>&gt;99.9%</td>
            <td>&lt;99.5%</td>
          </tr>
          <tr>
            <td><strong>Auto-Healing Events</strong></td>
            <td>&lt;10/dÃ­a</td>
            <td>&gt;50/dÃ­a</td>
          </tr>
          <tr>
            <td><strong>Rollback Rate</strong></td>
            <td>&lt;5% de deploys</td>
            <td>&gt;10%</td>
          </tr>
          <tr>
            <td><strong>Data Loss</strong></td>
            <td>0 bytes</td>
            <td>Cualquier pÃ©rdida</td>
          </tr>
        </tbody>
      </table>

      <div class="success">
        <strong>Resultado Esperado:</strong><br />
        Un sistema bancario que <strong>nunca falla completamente</strong>, se
        <strong>adapta a la demanda</strong> automÃ¡ticamente y se
        <strong>auto-recupera de fallos</strong> en segundos, manteniendo 99.9%
        uptime garantizado.
      </div>
    </div>

    <div class="footer">
      <p>Propuesta de Arquitectura - Sistema Bancario BP | CapÃ­tulo 11 de 17</p>
    </div>
  </body>
</html>
