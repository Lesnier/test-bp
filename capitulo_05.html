<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Capítulo 5 - Sistema de Auditoría con GraphQL</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="nav-header">
      <h2>Capítulo 5: Sistema de Auditoría con GraphQL</h2>
      <div class="nav-buttons">
        <a href="capitulo_04.html" class="nav-btn">← Anterior</a>
        <a href="index.html" class="nav-btn">Índice</a>
        <a href="capitulo_06.html" class="nav-btn">Siguiente →</a>
      </div>
    </div>

    <h1>5. SISTEMA DE AUDITORÍA CON GRAPHQL</h1>

    <h2>5.1 Arquitectura de Auditoría</h2>

    <div class="section">
      <p>
        El sistema implementa un microservicio dedicado para cumplimiento
        normativo y trazabilidad completa, utilizando
        <strong>GraphQL</strong> como interfaz principal y
        <strong>Worker Threads</strong> para procesamiento paralelo de eventos.
      </p>

      <div class="diagram">
        <div class="diagram-title">Arquitectura Completa de Auditoría</div>
        <pre class="mermaid">
               graph TD
                    %% 1. Definición de Nodos (la estructura del diagrama)
                    A["Todos los Microservicios<br/> (Emisores de Eventos)"]
                    B["KAFKA EVENT BUS<br/>
                        Topic: audit.events"]
                    C["MS-Auditoría<br/>(GraphQL API)<br/><br/>
                          Worker Pool (4 workers)<br/>
                          - Event Processing<br/>
                          - Log Enrichment<br/>
                          - Compliance Checks<br/>
                          - Anomaly Detection"]
                    D["<strong>Elasticsearch</strong><br/>(Event Store)<br/><br/>
                    - Full-text<br/>
                    - Aggregations<br/>
                    - 7 años"]
                    E["<strong>Prometheus</strong><br/>(Métricas)<br/><br/>
                    - Counters<br/>
                    - Histograms<br/>
                    - Alerts"]
                    F["<strong>PostgreSQL</strong><br/>(Audit Records)<br/><br/>
                    - Structured<br/>
                    - Compliance<br/>
                    - 10 años"]
                    G["<strong>Kibana</strong><br/>(Explorador)<br/>(Compliance)"]
                    H["<strong>Grafana</strong><br/>(Dashboards)<br/>(Métricas)"]

                    %% 2. Definición de Conexiones (las flechas)
                    A -- "Emit Events" --> B
                    B -- "Consume" --> C
                    C --> D
                    C --> E
                    C --> F
                    D --> G
                    E --> H

                    %% 3. Definición de Estilos (colores, bordes, etc.)
                    
                    %% Nivel 1: Emisores
                    classDef level1 fill:#EBF5FB,stroke:#85C1E9,stroke-width:2px,rx:10,ry:10,color:#333
                    
                    %% Nivel 2: Bus de Eventos
                    classDef level2 fill:#E8F8F5,stroke:#76D7C4,stroke-width:2px,rx:10,ry:10,color:#333
                    
                    %% Nivel 3: Consumidor Principal
                    classDef level3 fill:#FEF9E7,stroke:#FAD7A0,stroke-width:2px,rx:10,ry:10,color:#333
                    
                    %% Nivel 4: Almacenamiento y Métricas
                    classDef level4 fill:#F4ECF7,stroke:#D7BDE2,stroke-width:2px,rx:10,ry:10,color:#333
                    
                    %% Nivel 5: Visualización
                    classDef level5 fill:#FDEDEC,stroke:#F5B7B1,stroke-width:2px,rx:10,ry:10,color:#333

                    %% 4. Asignación de Estilos a los Nodos
                    class A level1
                    class B level2
                    class C level3
                    class D,E,F level4
                    class G,H level5
        </pre>
      </div>
    </div>

    <h2>5.2 GraphQL API de Auditoría</h2>

    <div class="section">
      <div class="success">
        <strong>Justificación de GraphQL para Auditoría:</strong>
        <ol>
          <li>
            <strong>Consultas Complejas Flexibles:</strong> Auditores necesitan
            filtros muy específicos sin crear nuevos endpoints
          </li>
          <li>
            <strong>Agregaciones Eficientes:</strong> Obtener estadísticas y
            métricas en una sola query
          </li>
          <li>
            <strong>Subscriptions en Tiempo Real:</strong> Monitoreo de eventos
            críticos vía WebSocket
          </li>
          <li>
            <strong>Type Safety:</strong> Schema fuertemente tipado para
            compliance
          </li>
          <li>
            <strong>Autodocumentación:</strong> GraphQL Playground como
            documentación interactiva
          </li>
          <li>
            <strong>Reducción de Latencia:</strong> 70-80% menos tiempo vs
            múltiples endpoints REST
          </li>
        </ol>
      </div>

      <h3>5.2.1 Schema GraphQL de Auditoría</h3>

      <pre>
# Tipo principal de evento de auditoría
type AuditEvent {
  id: ID!
  timestamp: DateTime!
  userId: String!
  action: AuditAction!
  resource: String!
  resourceId: String
  metadata: JSON!
  ipAddress: String!
  userAgent: String
  result: AuditResult!
  severity: AuditSeverity!
  riskScore: Int
  geoLocation: GeoLocation
}

# Enumeraciones para tipo de acción
enum AuditAction {
  LOGIN
  LOGOUT
  LOGIN_FAILED
  TRANSFER_CREATED
  TRANSFER_APPROVED
  TRANSFER_REJECTED
  ACCOUNT_ACCESSED
  PASSWORD_CHANGED
  PROFILE_UPDATED
  DOCUMENT_UPLOADED
  DOCUMENT_DOWNLOADED
  ADMIN_ACTION
  SETTINGS_CHANGED
  API_KEY_GENERATED
}

# Resultado de la operación
enum AuditResult {
  SUCCESS
  FAILURE
  PARTIAL
  PENDING
}

# Severidad del evento
enum AuditSeverity {
  INFO
  WARNING
  CRITICAL
}

# Información geográfica
type GeoLocation {
  country: String
  city: String
  latitude: Float
  longitude: Float
}

# Estadísticas agregadas
type AuditStatistics {
  totalEvents: Int!
  successRate: Float!
  failuresByAction: [ActionCount!]!
  eventsByHour: [HourlyCount!]!
  topUsers: [UserActivity!]!
  criticalEventsCount: Int!
  averageRiskScore: Float!
}

type ActionCount {
  action: AuditAction!
  count: Int!
  failureRate: Float!
}

type HourlyCount {
  hour: DateTime!
  count: Int!
  suspiciousActivity: Boolean!
}

type UserActivity {
  userId: String!
  eventCount: Int!
  riskScore: Float!
  lastActivity: DateTime!
}

# Queries
type Query {
  # Búsqueda flexible de eventos
  auditEvents(
    startDate: DateTime!
    endDate: DateTime!
    userId: String
    actions: [AuditAction!]
    severity: AuditSeverity
    minRiskScore: Int
    limit: Int = 100
    offset: Int = 0
  ): [AuditEvent!]!
  
  # Estadísticas agregadas
  auditStatistics(
    startDate: DateTime!
    endDate: DateTime!
    groupBy: StatGrouping
  ): AuditStatistics!
  
  # Búsqueda por texto completo
  searchAuditLogs(
    query: String!
    limit: Int = 50
  ): [AuditEvent!]!
  
  # Análisis de riesgo de usuario
  userRiskAnalysis(
    userId: String!
    days: Int = 30
  ): UserRiskProfile!
}

# Subscriptions para tiempo real
type Subscription {
  # Eventos críticos en tiempo real
  criticalEvents: AuditEvent!
  
  # Eventos por usuario específico
  userEvents(userId: String!): AuditEvent!
  
  # Eventos por tipo de acción
  actionEvents(action: AuditAction!): AuditEvent!
}
    </pre
      >

      <h3>5.2.2 Ejemplo de Query Compleja</h3>

      <pre>
# Dashboard de compliance para último mes
query ComplianceDashboard {
  # Estadísticas generales
  stats: auditStatistics(
    startDate: "2025-09-06T00:00:00Z"
    endDate: "2025-10-06T00:00:00Z"
    groupBy: ACTION
  ) {
    totalEvents
    successRate
    criticalEventsCount
    averageRiskScore
    
    failuresByAction {
      action
      count
      failureRate
    }
    
    eventsByHour {
      hour
      count
      suspiciousActivity
    }
    
    topUsers {
      userId
      eventCount
      riskScore
      lastActivity
    }
  }
  
  # Eventos críticos del último mes
  criticalTransfers: auditEvents(
    startDate: "2025-09-06T00:00:00Z"
    endDate: "2025-10-06T00:00:00Z"
    actions: [TRANSFER_CREATED]
    severity: CRITICAL
    minRiskScore: 50
  ) {
    id
    timestamp
    userId
    metadata
    result
    riskScore
    geoLocation {
      country
      city
    }
  }
  
  # Análisis de riesgo de usuarios sospechosos
  suspiciousUsers: auditEvents(
    startDate: "2025-09-06T00:00:00Z"
    endDate: "2025-10-06T00:00:00Z"
    minRiskScore: 70
  ) {
    userId
    action
    riskScore
    timestamp
    ipAddress
  }
}
    </pre
      >

      <div class="success">
        <strong>Beneficio vs REST:</strong><br />
        - <strong>REST requeriría:</strong> 5-6 endpoints diferentes, múltiples
        requests<br />
        - <strong>GraphQL requiere:</strong> 1 query única<br />
        - <strong>Reducción de latencia:</strong> 70-80% menos tiempo total<br />
        - <strong>Bandwidth:</strong> 65% menos datos transferidos
      </div>
    </div>

    <h2>5.3 Procesamiento con Worker Threads</h2>

    <div class="section">
      <p>
        Los eventos de auditoría se procesan en paralelo utilizando Worker
        Threads de Node.js para:
      </p>
      <ul>
        <li>Enriquecimiento de eventos (GeoIP lookup)</li>
        <li>Cálculo de risk scoring</li>
        <li>Detección de anomalías</li>
        <li>Verificación de compliance rules</li>
      </ul>

      <div class="diagram">
        <div class="diagram-title">
          Arquitectura de Worker Pool para Auditoría
        </div>
        <pre class="mermaid">
flowchart LR
    %% 1. Definición de Nodos con Iconos
    main["fa:fa-sitemap MS-Auditoría - Main Thread<br/>
      - Coordina y consume<br/>
      - Responde a GraphQL"]
    
    subgraph "⚙️ Worker Pool"
        direction TB
        w1["Worker1: GeoIP Lookup"]
        w2["Worker2: Risk Scoring"]
        w3["Worker3:&nbsp;Anomaly&nbsp;Detection"]
        w4["Worker4:&nbsp;Compliance&nbsp;Checks"]
    end

    db["fa:fa-database Almacenamiento<br/>
    Elasticsearch<br/>
    + PostgreSQL"]

    %% 2. Conexiones con diferentes estilos
    main -.->|Delega Tarea| w1
    main -.->|Delega Tarea| w2
    main -.->|Delega Tarea| w3
    main -.->|Delega Tarea| w4
    
    w1 & w2 & w3 & w4 -- "Eventos Enriquecidos" --> db
    
    %% 3. Estilos
    classDef level1 fill:#EBF5FB,stroke:#85C1E9,stroke-width:2px,rx:10,ry:10
    classDef level2 fill:#F4ECF7,stroke:#D7BDE2,stroke-width:2px,rx:10,ry:10
    classDef level3 fill:#FEF9E7,stroke:#FAD7A0,stroke-width:2px,rx:10,ry:10

    %% 4. Asignación de Estilos
    class main level1
    class w1,w2,w3,w4 level2
    class db level3
        </pre>
      </div>

      <h3>5.3.1 Performance con Workers</h3>

      <table>
        <thead>
          <tr>
            <th>Métrica</th>
            <th>Sin Workers</th>
            <th>Con 4 Workers</th>
            <th>Mejora</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Eventos procesados/segundo</td>
            <td>800</td>
            <td>3,200</td>
            <td class="pros">↑ 300%</td>
          </tr>
          <tr>
            <td>Latencia promedio</td>
            <td>45ms</td>
            <td>12ms</td>
            <td class="pros">↑ 73%</td>
          </tr>
          <tr>
            <td>CPU utilizada</td>
            <td>25% (1 core)</td>
            <td>85% (4 cores)</td>
            <td class="pros">Óptimo</td>
          </tr>
          <tr>
            <td>Throughput total</td>
            <td>2,880 eventos/hora</td>
            <td>11,520 eventos/hora</td>
            <td class="pros">↑ 300%</td>
          </tr>
        </tbody>
      </table>

      <h3>5.3.2 Enriquecimiento de Eventos</h3>

      <p>
        Cada evento pasa por el siguiente proceso de enriquecimiento en workers:
      </p>

      <ol>
        <li>
          <strong>GeoIP Lookup:</strong> Determinar ubicación geográfica desde
          IP
        </li>
        <li><strong>Risk Scoring:</strong> Calcular score de riesgo (0-100)</li>
        <li><strong>Anomaly Detection:</strong> Detectar patrones inusuales</li>
        <li>
          <strong>Compliance Checks:</strong> Verificar reglas de compliance
        </li>
        <li>
          <strong>User Context:</strong> Agregar información contextual del
          usuario
        </li>
      </ol>

      <pre>
// Ejemplo de enriquecimiento en Worker
function enrichEvent(event) {
  return {
    ...event,
    
    // GeoIP Lookup (CPU-intensive)
    geoLocation: lookupGeoIP(event.ipAddress),
    
    // Risk Scoring (cálculo complejo)
    riskScore: calculateRiskScore({
      action: event.action,
      time: event.timestamp,
      location: geoLocation,
      userHistory: getUserHistory(event.userId)
    }),
    
    // Anomaly Detection (ML model)
    isAnomaly: detectAnomaly(event, userBehaviorProfile),
    
    // Compliance Flags
    complianceFlags: checkComplianceRules(event)
  };
}
    </pre
      >
    </div>

    <h2>5.4 GraphQL Subscriptions en Tiempo Real</h2>

    <div class="section">
      <p>
        Las subscriptions de GraphQL permiten monitoreo en tiempo real de
        eventos críticos vía WebSocket.
      </p>

      <h3>5.4.1 Implementación de Subscriptions</h3>

      <pre>
// GraphQL Resolver para Subscriptions
const { PubSub } = require('graphql-subscriptions');
const pubsub = new PubSub();

// Kafka consumer publica a GraphQL subscription
kafka.consumer.on('message', (message) => {
  const event = JSON.parse(message.value);
  
  // Procesar en worker thread
  workerPool.process(event).then(enrichedEvent => {
    
    // Publicar eventos críticos
    if (enrichedEvent.severity === 'CRITICAL') {
      pubsub.publish('CRITICAL_EVENT', {
        criticalEvents: enrichedEvent
      });
    }
    
    // Publicar eventos por usuario
    pubsub.publish(`USER_EVENT_${enrichedEvent.userId}`, {
      userEvents: enrichedEvent
    });
    
    // Publicar eventos por acción
    pubsub.publish(`ACTION_${enrichedEvent.action}`, {
      actionEvents: enrichedEvent
    });
  });
});

// Resolvers
const resolvers = {
  Subscription: {
    criticalEvents: {
      subscribe: () => pubsub.asyncIterator(['CRITICAL_EVENT'])
    },
    
    userEvents: {
      subscribe: (_, { userId }) => 
        pubsub.asyncIterator([`USER_EVENT_${userId}`])
    },
    
    actionEvents: {
      subscribe: (_, { action }) => 
        pubsub.asyncIterator([`ACTION_${action}`])
    }
  }
};
    </pre
      >

      <h3>5.4.2 Cliente Subscription (Frontend)</h3>

      <pre>
// React component con GraphQL Subscription
import { useSubscription } from '@apollo/client';

const CRITICAL_EVENTS_SUBSCRIPTION = gql`
  subscription OnCriticalEvent {
    criticalEvents {
      id
      timestamp
      userId
      action
      severity
      riskScore
      metadata
    }
  }
`;

function ComplianceDashboard() {
  const { data, loading } = useSubscription(
    CRITICAL_EVENTS_SUBSCRIPTION
  );
  
  useEffect(() => {
    if (data?.criticalEvents) {
      // Mostrar alerta en tiempo real
      showAlert(data.criticalEvents);
      
      // Reproducir sonido de alerta
      playAlertSound();
    }
  }, [data]);
  
  return (
    &lt;div&gt;
      {data?.criticalEvents && (
        &lt;Alert severity="error"&gt;
          Evento Crítico Detectado: {data.criticalEvents.action}
        &lt;/Alert&gt;
      )}
    &lt;/div&gt;
  );
}
    </pre
      >

      <div class="success">
        <strong>Ventajas de Subscriptions:</strong>
        <ul>
          <li>
            Latencia ultra-baja: &lt;100ms desde evento hasta visualización
          </li>
          <li>Sin polling: Conexión WebSocket persistente</li>
          <li>Eficiencia: Solo se envían datos cuando hay cambios</li>
          <li>Ideal para dashboards de compliance en tiempo real</li>
        </ul>
      </div>
    </div>

    <h2>5.5 Almacenamiento y Retención</h2>

    <div class="section">
      <h3>5.5.1 Estrategia de Almacenamiento Multi-Tier</h3>

      <table>
        <thead>
          <tr>
            <th>Tipo de Dato</th>
            <th>Retención</th>
            <th>Storage</th>
            <th>Justificación Normativa</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Logs de aplicación</td>
            <td>90 días</td>
            <td>Elasticsearch (hot)</td>
            <td>Operación diaria, debugging</td>
          </tr>
          <tr>
            <td>Eventos de auditoría</td>
            <td>7 años</td>
            <td>Elasticsearch + S3</td>
            <td>PCI DSS Requirement 10.7, GLBA</td>
          </tr>
          <tr>
            <td>Transacciones financieras</td>
            <td>10 años</td>
            <td>PostgreSQL + S3 Glacier</td>
            <td>Normativas bancarias locales</td>
          </tr>
          <tr>
            <td>Datos de acceso (login)</td>
            <td>2 años</td>
            <td>Elasticsearch</td>
            <td>ISO 27001, GDPR Art. 32</td>
          </tr>
          <tr>
            <td>Métricas Prometheus</td>
            <td>30 días</td>
            <td>Prometheus TSDB</td>
            <td>Análisis de tendencias</td>
          </tr>
          <tr>
            <td>Eventos críticos</td>
            <td>10 años</td>
            <td>PostgreSQL + S3</td>
            <td>Compliance y legal</td>
          </tr>
        </tbody>
      </table>

      <h3>5.5.2 Política de Lifecycle</h3>

      <div class="diagram">
        <div class="diagram-title">Ciclo de Vida de Datos de Auditoría</div>
        <pre class="mermaid">
flowchart TD
    subgraph "Ciclo de Vida del Dato"
        direction LR

        tier_hot_data("Días 0-30"):::level_hot
        hot_es["fa:fa-fire&nbsp;&nbsp;<strong>Elasticsearch Hot</strong><br/>SSD | &lt;50ms | Alto Costo<br/>Consultas Frecuentes, Dashboards"]:::level_hot_data

        tier_warm_data("Días 31-365"):::level_warm
        warm_es["fa:fa-thermometer-half&nbsp;&nbsp;<strong>Elasticsearch Warm</strong><br/>HDD | &lt;200ms | Medio Costo<br/>Consultas Ocasionales, Reportes Mensuales"]:::level_warm_data

        tier_s3_standard_data("Años 1-3"):::level_cold
        s3_standard["fa:fa-snowflake&nbsp;&nbsp;<strong>Amazon S3 Standard</strong><br/>Blob | Minutos Restore | Costo Medio<br/>Auditorías Anuales"]:::level_cold_data

        tier_glacier_data("Años 3-7"):::level_frozen
        s3_glacier["fa:fa-ice-cream&nbsp;&nbsp;<strong>Amazon S3 Glacier</strong><br/>Archival | 3-5h Restore | Bajo Costo<br/>Solo Compliance"]:::level_frozen_data

        tier_deep_archive_data("Años 7-10"):::level_archive
        s3_deep_archive["fa:fa-box-open&nbsp;&nbsp;<strong>S3 Glacier Deep Archive</strong><br/>Deep Archival | 12-48h Restore | Mínimo Costo<br/>Legal / Auditorías Externas"]:::level_archive_data
    end

    %% Conexiones y transiciones
    tier_hot_data --> hot_es
    hot_es -- "Después de 30 días" --> tier_warm_data
    tier_warm_data --> warm_es
    warm_es -- "Después de 365 días" --> tier_s3_standard_data
    tier_s3_standard_data --> s3_standard
    s3_standard -- "Después de 3 años" --> tier_glacier_data
    tier_glacier_data --> s3_glacier
    s3_glacier -- "Después de 7 años" --> tier_deep_archive_data
    tier_deep_archive_data --> s3_deep_archive

    %% Estilos de los nodos
    classDef level_hot fill:#EBF5FB,stroke:#85C1E9,stroke-width:2px,rx:8,ry:8,color:#222;
    classDef level_warm fill:#E8F8F5,stroke:#76D7C4,stroke-width:2px,rx:8,ry:8,color:#222;
    classDef level_cold fill:#FEF9E7,stroke:#FAD7A0,stroke-width:2px,rx:8,ry:8,color:#222;
    classDef level_frozen fill:#F4ECF7,stroke:#D7BDE2,stroke-width:2px,rx:8,ry:8,color:#222;
    classDef level_archive fill:#FDEDEC,stroke:#F5B7B1,stroke-width:2px,rx:8,ry:8,color:#222;

    %% Estilos de los nodos de datos (más prominentes)
    classDef level_hot_data fill:#D6EEF9,stroke:#5DA6D9,stroke-width:3px,rx:12,ry:12,color:#111,font-size:14px;
    classDef level_warm_data fill:#D2F3EE,stroke:#4DC4AC,stroke-width:3px,rx:12,ry:12,color:#111,font-size:14px;
    classDef level_cold_data fill:#FCF3DA,stroke:#E9B87F,stroke-width:3px,rx:12,ry:12,color:#111,font-size:14px;
    classDef level_frozen_data fill:#EAD7EE,stroke:#C08BD1,stroke-width:3px,rx:12,ry:12,color:#111,font-size:14px;
    classDef level_archive_data fill:#FBCAC8,stroke:#ED8581,stroke-width:3px,rx:12,ry:12,color:#111,font-size:14px;
        </pre>
      </div>

      <div class="note">
        <strong>Ahorro Estimado:</strong> La política de lifecycle reduce costos
        de almacenamiento en 75% vs mantener todo en Elasticsearch hot tier.
      </div>
    </div>

    <h2>5.6 Dashboards y Visualización</h2>

    <div class="section">
      <h3>5.6.1 Kibana para Exploración</h3>

      <ul>
        <li>
          <strong>Discover:</strong> Búsqueda ad-hoc de eventos con filtros
          complejos
        </li>
        <li>
          <strong>Visualize:</strong> Gráficos de tendencias, mapas de calor,
          geo-mapas
        </li>
        <li>
          <strong>Dashboard:</strong> Vistas personalizadas por rol (auditor,
          compliance, security)
        </li>
        <li>
          <strong>Alertas:</strong> Notificaciones automáticas en eventos
          sospechosos
        </li>
      </ul>

      <h3>5.6.2 Grafana para Métricas</h3>

      <ul>
        <li>
          <strong>Performance Metrics:</strong> Latencia, throughput, error rate
        </li>
        <li>
          <strong>Business Metrics:</strong> Transacciones/hora, usuarios
          activos
        </li>
        <li>
          <strong>Security Metrics:</strong> Intentos de login fallidos, eventos
          críticos
        </li>
        <li>
          <strong>Compliance Metrics:</strong> Tasa de eventos auditados,
          coverage
        </li>
      </ul>

      <h3>5.6.3 Ejemplos de Dashboards</h3>

      <table>
        <thead>
          <tr>
            <th>Dashboard</th>
            <th>Usuario</th>
            <th>Contenido</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Security Overview</strong></td>
            <td>CISO, Security Team</td>
            <td>
              Eventos críticos, intentos de acceso fallidos, anomalías
              detectadas
            </td>
          </tr>
          <tr>
            <td><strong>Compliance Report</strong></td>
            <td>Compliance Officer</td>
            <td>
              Cobertura de auditoría, eventos por normativa, gaps detectados
            </td>
          </tr>
          <tr>
            <td><strong>Operations Monitor</strong></td>
            <td>DevOps, SRE</td>
            <td>Performance del sistema, errores, latencias, uptime</td>
          </tr>
          <tr>
            <td><strong>User Activity</strong></td>
            <td>Fraud Team</td>
            <td>Actividad por usuario, patrones sospechosos, risk scores</td>
          </tr>
          <tr>
            <td><strong>Transaction Audit</strong></td>
            <td>Finance Team</td>
            <td>Transacciones por tipo, montos, tendencias, reconciliación</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h2>5.7 Alertas y Monitoreo Proactivo</h2>

    <div class="section">
      <h3>5.7.1 Reglas de Alertas</h3>

      <table>
        <thead>
          <tr>
            <th>Alerta</th>
            <th>Condición</th>
            <th>Severidad</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Login desde país desconocido</td>
            <td>GeoLocation no en lista blanca</td>
            <td>CRITICAL</td>
            <td>PagerDuty + Bloqueo temporal</td>
          </tr>
          <tr>
            <td>Múltiples logins fallidos</td>
            <td>&gt;5 intentos en 5 minutos</td>
            <td>WARNING</td>
            <td>Email + Captcha activado</td>
          </tr>
          <tr>
            <td>Transferencia de alto monto</td>
            <td>Monto &gt; $50,000</td>
            <td>INFO</td>
            <td>Notificación a compliance</td>
          </tr>
          <tr>
            <td>Anomalía detectada</td>
            <td>Risk score &gt; 80</td>
            <td>CRITICAL</td>
            <td>PagerDuty + Revisión manual</td>
          </tr>
          <tr>
            <td>Acceso admin fuera de horario</td>
            <td>Login admin 10pm-6am</td>
            <td>WARNING</td>
            <td>Slack + Email al CISO</td>
          </tr>
        </tbody>
      </table>

      <h3>5.7.2 Canales de Notificación</h3>

      <ul>
        <li>
          <strong>PagerDuty:</strong> Eventos críticos que requieren acción
          inmediata
        </li>
        <li>
          <strong>Slack:</strong> Alertas de severidad media, notificaciones al
          equipo
        </li>
        <li><strong>Email:</strong> Reportes diarios, resúmenes semanales</li>
        <li>
          <strong>SMS:</strong> Solo para eventos críticos fuera de horario
        </li>
        <li>
          <strong>Dashboard:</strong> Visualización en tiempo real con GraphQL
          Subscriptions
        </li>
      </ul>
    </div>

    <h2>5.8 Cumplimiento Normativo</h2>

    <div class="section">
      <h3>5.8.1 Requisitos Cubiertos</h3>

      <div class="success">
        <strong>✓ ISO 27001 - Control A.12.4 (Logging and Monitoring):</strong>
        <ul>
          <li>Logs de todos los eventos de acceso y modificación</li>
          <li>Protección de logs contra alteración</li>
          <li>Retención según política (mínimo 1 año)</li>
        </ul>

        <strong>✓ PCI DSS Requirement 10:</strong>
        <ul>
          <li>
            Track and monitor all access to network resources and cardholder
            data
          </li>
          <li>Implement automated audit trails (Kafka + Elasticsearch)</li>
          <li>
            Retain audit trail history for at least one year (7 años
            implementado)
          </li>
          <li>Use time-synchronization technology (NTP configurado)</li>
        </ul>

        <strong>✓ GDPR Art. 32 - Security of Processing:</strong>
        <ul>
          <li>Ability to ensure ongoing confidentiality and integrity</li>
          <li>Ability to restore availability after incident</li>
          <li>Process for regularly testing and evaluating effectiveness</li>
        </ul>

        <strong>✓ GLBA - Safeguards Rule:</strong>
        <ul>
          <li>Design and implement safeguards to control risks</li>
          <li>Regularly monitor and test effectiveness of safeguards</li>
        </ul>
      </div>
    </div>

    <h2>5.9 Ventajas del Sistema de Auditoría con GraphQL</h2>

    <div class="section">
      <div class="success">
        <h3>✓ Beneficios Comprobados</h3>
        <ol>
          <li>
            <strong>GraphQL Efficiency:</strong> 70-80% reducción en latencia vs
            REST múltiple
          </li>
          <li>
            <strong>Worker Threads:</strong> 300% mejora en throughput de
            procesamiento
          </li>
          <li>
            <strong>Real-time Monitoring:</strong> Subscriptions con &lt;100ms
            de latencia
          </li>
          <li>
            <strong>Flexible Queries:</strong> Auditores pueden crear queries
            personalizadas sin desarrollo
          </li>
          <li>
            <strong>Compliance Ready:</strong> Cumple ISO 27001, PCI DSS, GDPR
            desde el diseño
          </li>
          <li>
            <strong>Cost Efficient:</strong> Lifecycle policy reduce costos 75%
          </li>
          <li>
            <strong>Scalable:</strong> Procesamiento de millones de eventos/día
            sin degradación
          </li>
        </ol>
      </div>
    </div>

    <div class="footer">
      <p>Propuesta de Arquitectura - Sistema Bancario BP | Capítulo 5 de 17</p>
    </div>

    <script src="mermaid.min.js"></script>
    <script src="panzoom.min.js"></script>
    <script src="app.js"></script>
  </body>
</html>
