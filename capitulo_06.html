<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cap√≠tulo 6 - Autenticaci√≥n OAuth 2.0 y Biometr√≠a</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="path/to/font-awesome/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    />
  </head>
  <body>
    <div class="nav-header">
      <h2>Cap√≠tulo 6: Autenticaci√≥n OAuth 2.0 y Biometr√≠a</h2>
      <div class="nav-buttons">
        <a href="capitulo-05.html" class="nav-btn">‚Üê Anterior</a>
        <a href="index.html" class="nav-btn">√çndice</a>
        <a href="capitulo-07.html" class="nav-btn">Siguiente ‚Üí</a>
      </div>
    </div>

    <h1>6. ARQUITECTURA DE AUTENTICACI√ìN OAUTH 2.0 Y BIOMETR√çA</h1>

    <h2>6.1 Flujo de Autenticaci√≥n Recomendado</h2>

    <div class="section">
      <p>
        La compa√±√≠a ya cuenta con un servicio OAuth 2.0, por lo que se
        implementa el flujo
        <strong>Authorization Code Flow with PKCE</strong> (Proof Key for Code
        Exchange), recomendado para aplicaciones m√≥viles y SPA por su mayor
        seguridad.
      </p>

      <div class="note">
        <strong>¬øPor qu√© PKCE?</strong>
        <ul>
          <li>
            Protege contra ataques de intercepci√≥n de c√≥digo de autorizaci√≥n
          </li>
          <li>
            No requiere client secret en aplicaciones p√∫blicas (m√≥vil/SPA)
          </li>
          <li>Recomendado por IETF (RFC 7636) para aplicaciones nativas</li>
          <li>Compatible con OAuth 2.0 est√°ndar</li>
        </ul>
      </div>
    </div>

    <h2>6.2 Diagrama de Flujo OAuth 2.0 con PKCE</h2>

    <div class="section">
      <p>
        Es un flujo est√°ndar para la seguridad de aplicaciones modernas. PKCE
        protege contra la intercepci√≥n del c√≥digo de autorizaci√≥n, garantizando
        que solo tu aplicaci√≥n pueda obtener los tokens. La combinaci√≥n de
        tokens de acceso y de refresco proporciona una sesi√≥n segura y duradera,
        mientras que la capa biom√©trica final ofrece una experiencia de usuario
        fluida y conveniente para inicios de sesi√≥n posteriores.
      </p>
    </div>

    <div class="section">
      <div class="diagram">
        <div class="diagram-title">Flujo Completo de Autenticaci√≥n</div>
        <pre class="mermaid">
sequenceDiagram
    participant App as App M√≥vil / SPA
    participant OAuth as OAuth Server<br/>Existente
    
    Note over App: 1. Generar code_verifier random
    Note over App: code_challenge = SHA256(code_verifier)
    
    App->>OAuth: 2. Solicitud de autorizaci√≥n<br/>+ code_challenge<br/>+ code_challenge_method = S256
    
    Note over OAuth: 3. Usuario ingresa credenciales<br/>user + password
    
    Note over OAuth: 4. [OPCIONAL] Factor adicional<br/>OTP/SMS
    
    OAuth-->>App: 5. Authorization Code<br/>v√°lido 60 segundos
    
    App->>OAuth: 6. Intercambio c√≥digo por tokens<br/>+ code_verifier para validar
    
    Note over OAuth: Valida:<br/>SHA256(code_verifier) == code_challenge
    
    OAuth-->>App: 7. Access Token JWT 15 min<br/>+ Refresh Token 30 d√≠as<br/>+ ID Token info usuario
    
    Note over App: 8. [OPCIONAL] Solicitud de biometr√≠a<br/>Face ID / Touch ID
    
    App->>App: 9. Validaci√≥n biom√©trica local<br/>Device Secure Enclave
    
    Note over App: 10. Token biom√©trico adicional<br/>almacenado localmente
        </pre>
      </div>

      <h3>6.2.1 Componentes del Flujo</h3>

      <table>
        <thead>
          <tr>
            <th>Componente</th>
            <th>Descripci√≥n</th>
            <th>Duraci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>code_verifier</strong></td>
            <td>Cadena aleatoria de 43-128 caracteres</td>
            <td>Un solo uso</td>
          </tr>
          <tr>
            <td><strong>code_challenge</strong></td>
            <td>SHA256(code_verifier) en base64url</td>
            <td>Un solo uso</td>
          </tr>
          <tr>
            <td><strong>authorization_code</strong></td>
            <td>C√≥digo temporal para intercambiar por tokens</td>
            <td>60 segundos</td>
          </tr>
          <tr>
            <td><strong>access_token</strong></td>
            <td>JWT firmado con claims del usuario</td>
            <td>15 minutos</td>
          </tr>
          <tr>
            <td><strong>refresh_token</strong></td>
            <td>Token opaco para renovar access_token</td>
            <td>30 d√≠as</td>
          </tr>
          <tr>
            <td><strong>id_token</strong></td>
            <td>JWT con informaci√≥n del usuario (OpenID)</td>
            <td>15 minutos</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h2>6.3 Integraci√≥n del Onboarding con Reconocimiento Facial</h2>

    <div class="section">
      <p>
        Durante el proceso de registro (onboarding), el sistema captura y valida
        la identidad del usuario mediante reconocimiento facial con
        <strong>liveness detection</strong>.
      </p>

      <h3>6.3.1 Flujo Completo de Onboarding</h3>

      <div class="diagram">
        <div class="diagram-title">Proceso de Registro con Biometr√≠a</div>
        <pre class="mermaid">
sequenceDiagram
    participant U as Usuario<br/>App M√≥vil
    participant AUTH as MS-Autenticaci√≥n
    participant SMS as SMS/Email<br/>Gateway
    participant KYC as MS-KYC
    participant OCR as OCR Engine<br/>Tesseract.js
    participant BIO as MS-Biometr√≠a
    participant REKN as AWS Rekognition<br/>Azure Face API
    participant VAULT as HashiCorp Vault
    
    Note over U,VAULT: PASO 1: Registro Inicial
    
    U->>AUTH: GraphQL Mutation: registerUser<br/>{nombre, email, tel√©fono, fecha, password}
    AUTH->>AUTH: Valida unicidad email/tel√©fono
    AUTH->>AUTH: Hash contrase√±a (bcrypt, salt: 12)
    AUTH->>AUTH: Crea usuario<br/>status: PENDING_VERIFICATION
    AUTH->>AUTH: Genera OTP 6 d√≠gitos<br/>v√°lido 10 min
    AUTH->>SMS: Env√≠a OTP por SMS/Email
    AUTH-->>U: 200 OK - Solicita OTP
    
    U->>U: Usuario ingresa OTP
    U->>AUTH: POST /api/auth/verify-otp<br/>{sessionId, otp}
    AUTH->>AUTH: Valida OTP (m√°ximo 3 intentos)
    
    alt OTP V√°lido
        AUTH->>AUTH: Status: PENDING_IDENTITY
        AUTH-->>U: ‚úì OTP Correcto - Siguiente paso
    else OTP Inv√°lido
        AUTH-->>U: ‚úó OTP Incorrecto - Reintentar
        U->>AUTH: Reintenta OTP
    end
    
    Note over U,VAULT: PASO 2: Verificaci√≥n de Identidad (KYC)
    
    U->>U: Captura foto documento<br/>frente y reverso
    U->>KYC: POST /api/documents/upload<br/>{images}
    KYC->>OCR: Procesa en Worker Thread
    OCR->>OCR: OCR extrae datos<br/>Nombre, N√∫mero ID, Fecha nacimiento
    OCR->>KYC: Datos extra√≠dos
    KYC->>KYC: Valida autenticidad<br/>Marcas de agua, Hologramas
    KYC->>KYC: Compara datos con registro<br/>Similarity > 90%
    KYC->>KYC: Valida watchlist<br/>AML/CFT OFAC ONU
    
    alt Validaci√≥n OK
        KYC->>AUTH: Status: PENDING_BIOMETRIC
        KYC-->>U: ‚úì Documentos verificados
    else Validaci√≥n Fallida
        KYC-->>U: ‚úó Documentos rechazados<br/>Registro cancelado
    end
    
    Note over U,VAULT: PASO 3: Registro Biom√©trico
    
    U->>U: Graba video selfie 3-5 seg<br/>Mueve cabeza, parpadea
    U->>BIO: POST /api/biometric/register-face<br/>{video}
    BIO->>BIO: Procesa en Worker Thread
    BIO->>BIO: Liveness Detection<br/>Movimiento, Parpadeo, Textura
    BIO->>REKN: Extrae vectores faciales<br/>embeddings
    REKN-->>BIO: Face embeddings + confidence
    BIO->>BIO: Compara rostro vs documento<br/>Similarity > 95%
    BIO->>VAULT: Almacena embeddings cifrados<br/>AES-256
    VAULT-->>BIO: ‚úì Almacenado
    
    alt Biometr√≠a V√°lida
        BIO->>AUTH: Status: ACTIVE
        BIO-->>U: ‚úì Registro biom√©trico exitoso
    else Biometr√≠a Fallida (intento 1-2)
        BIO-->>U: ‚úó Intento fallido<br/>Reintentar (m√°x 3)
        U->>BIO: Nuevo intento
    else Biometr√≠a Fallida (intento 3)
        BIO-->>U: ‚úó Registro rechazado<br/>M√°ximo de intentos alcanzado
    end
    
    Note over U,VAULT: PASO 4: Activaci√≥n de Cuenta
    
    AUTH->>SMS: Notificaci√≥n cuenta activada
    SMS-->>U: SMS/Email: "Cuenta activada"
    AUTH-->>U: Biometr√≠a habilitada<br/>Face ID / Touch ID
    U->>U: Usuario puede hacer login
    
    Note over U: ‚úì Onboarding Completo<br/>Usuario: ACTIVE
</pre>
      </div>
    </div>

    <h2>6.4 M√©todos de Autenticaci√≥n Post-Registro</h2>

    <div class="section">
      <p>
        Una vez completado el onboarding, el usuario puede autenticarse mediante
        m√∫ltiples m√©todos, ordenados por nivel de seguridad:
      </p>

      <table>
        <thead>
          <tr>
            <th>M√©todo</th>
            <th>Tecnolog√≠a</th>
            <th>Seguridad</th>
            <th>UX</th>
            <th>Tiempo</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Face ID / Face Recognition</strong></td>
            <td>Biometr√≠a facial + Liveness</td>
            <td class="pros">Muy Alta</td>
            <td class="pros">Excelente</td>
            <td>~2 segundos</td>
          </tr>
          <tr>
            <td><strong>Touch ID / Fingerprint</strong></td>
            <td>Sensor biom√©trico dispositivo</td>
            <td class="pros">Muy Alta</td>
            <td class="pros">Excelente</td>
            <td>~1 segundo</td>
          </tr>
          <tr>
            <td><strong>Usuario + Contrase√±a + OTP</strong></td>
            <td>TOTP (Google Authenticator)</td>
            <td class="pros">Alta</td>
            <td>Buena</td>
            <td>~15 segundos</td>
          </tr>
          <tr>
            <td><strong>Usuario + Contrase√±a</strong></td>
            <td>Bcrypt hash + Salt</td>
            <td>Media</td>
            <td>Est√°ndar</td>
            <td>~10 segundos</td>
          </tr>
          <tr>
            <td><strong>PIN de 6 d√≠gitos</strong></td>
            <td>Cifrado local</td>
            <td>Media</td>
            <td>R√°pida</td>
            <td>~3 segundos</td>
          </tr>
        </tbody>
      </table>

      <h3>6.4.1 Flujo de Login con Biometr√≠a</h3>

      <div class="diagram">
        <div class="diagram-title">Proceso de Login con Biometr√≠a</div>
        <pre class="mermaid">
sequenceDiagram
    participant U as Usuario
    participant APP as App M√≥vil
    participant OS as Sistema Operativo<br/>iOS/Android
    participant SE as Secure Enclave<br/>Face ID/Touch ID/Fingerprint
    participant KS as Keychain iOS<br/>Keystore Android
    participant AUTH as MS-Autenticaci√≥n
    participant VAULT as HashiCorp Vault
    
    Note over U,VAULT: Flujo de Login Biom√©trico (< 3 segundos)
    
    U->>APP: Abre aplicaci√≥n bancaria
    APP->>OS: Detecta soporte de biometr√≠a
    OS-->>APP: ‚úì Biometr√≠a disponible
    
    APP->>OS: Solicita autenticaci√≥n biom√©trica
    OS->>U: Muestra prompt<br/>Face ID / Touch ID / Fingerprint
    
    alt iOS
        U->>SE: Face ID / Touch ID
        SE->>SE: Valida en Secure Enclave
    else Android
        U->>SE: BiometricPrompt API
        SE->>SE: Valida en hardware
    end
    
    alt Biometr√≠a Exitosa
        SE-->>OS: ‚úì Autenticaci√≥n exitosa
        OS-->>APP: ‚úì Biometr√≠a v√°lida
        
        APP->>KS: Recupera token biom√©trico local
        KS-->>APP: Token cifrado
        
        APP->>AUTH: POST /api/auth/biometric-login<br/>{biometricToken, deviceId}
        AUTH->>AUTH: Valida token biom√©trico
        AUTH->>VAULT: Solicita embeddings del usuario
        VAULT-->>AUTH: Embeddings cifrados (AES-256)
        AUTH->>AUTH: Compara embeddings<br/>Similarity > 95%
        
        AUTH->>AUTH: Genera JWT tokens
        AUTH-->>APP: 200 OK<br/>{accessToken (15min), refreshToken (30d)}
        
        APP->>APP: Almacena tokens en Keychain/Keystore
        APP-->>U: ‚úì Login exitoso<br/>Redirige a dashboard
        
        Note over U: Total: ~2 segundos
        
    else Biometr√≠a Fallida
        SE-->>OS: ‚úó Autenticaci√≥n fallida
        OS-->>APP: ‚úó Biometr√≠a inv√°lida
        APP-->>U: ‚úó Autenticaci√≥n rechazada<br/>Intenta con contrase√±a
        
        Note over U: Fallback a login tradicional
    end
      </pre>
      </div>
    </div>

    <h2>6.5 Arquitectura de Seguridad</h2>

    <div class="section">
      <h3>6.5.1 HashiCorp Vault para Gesti√≥n de Secretos</h3>

      <div class="diagram">
        <div class="diagram-title">Arquitectura de Vault</div>
        <pre class="mermaid">
flowchart TD
    %% Contenedor principal del cl√∫ster
    subgraph "üîí HASHICORP VAULT CLUSTER"
        %% Nodos de Vault
        subgraph " "
            direction LR
            v1["fa:fa-server Vault 1<br/><strong>(Active)</strong>"]:::activeNode
            v2["fa:fa-server Vault 2<br/>(Standby)"]:::standbyNode
            v3["fa:fa-server Vault 3<br/>(Standby)"]:::standbyNode
        end
        
        %% Backend de almacenamiento
        storage["fa:fa-database Storage Backend<br/>(Consul/etcd)"]:::storageStyle

        %% --- Conexiones Internas ---
        %% Comunicaci√≥n para Alta Disponibilidad (HA)
        v1 <--> v2
        v2 <--> v3
        
        %% Conexi√≥n de todos los nodos al storage
        v1 & v2 & v3 ==> storage
    end

    %% --- Consumidores Externos ---
    subgraph " "
        direction LR
        k8s["fa:fa-dharmachakra Kubernetes<br/>(Secrets Injection)"]:::consumerStyle
        apps["fa:fa-mobile-alt Apps<br/>(API Keys)"]:::consumerStyle
        cicd["fa:fa-cogs CI/CD<br/>(Deploy Secrets)"]:::consumerStyle
    end

    %% --- Flujo de Secretos (Externo) ---
    %% El nodo ACTIVO es el que sirve los secretos
    v1 -- "üîë Serves Secrets" --> k8s
    v1 -- "üîë Serves Secrets" --> apps
    v1 -- "üîë Serves Secrets" --> cicd

    %% --- ESTILOS ---
    %% Estilos para Nodos
    classDef activeNode fill:#E8F8F5,stroke:#1ABC9C,stroke-width:3px,color:#212529,rx:10,ry:10
    classDef standbyNode fill:#F4F6F7,stroke:#909497,stroke-width:2px,color:#343A40,rx:10,ry:10
    classDef storageStyle fill:#FEF9E7,stroke:#F39C12,stroke-width:2px,color:#212529,rx:10,ry:10
    classDef consumerStyle fill:#EBF5FB,stroke:#3498DB,stroke-width:2px,color:#212529,rx:10,ry:10

    %% Estilos para el Contenedor del Cl√∫ster
    classDef mainCluster fill:#F8F9FA,stroke:#495057,stroke-width:2px,stroke-dasharray: 5 5,rx:15,ry:15
    class mainCluster subgraphStyle

    %% Estilos para las L√≠neas/Conexiones
    %% Enlaces de HA (punteados y delgados)
    linkStyle 0,1 stroke:#909497,stroke-width:2px,stroke-dasharray: 3 3
    %% Enlace principal de entrega de secretos (grueso y de color)
    linkStyle 5,6,7 stroke:#1ABC9C,stroke-width:3px

        </pre>
      </div>

      <h4>Secretos Gestionados en Vault:</h4>
      <ul>
        <li>
          <strong>Credenciales de bases de datos</strong> (rotaci√≥n autom√°tica
          cada 90 d√≠as)
        </li>
        <li>
          <strong>API keys de servicios externos</strong> (Firebase, AWS
          Rekognition, etc.)
        </li>
        <li><strong>Certificados SSL/TLS</strong></li>
        <li><strong>Claves de cifrado</strong> (AES-256)</li>
        <li><strong>OAuth client secrets</strong></li>
        <li><strong>Claves de firma JWT</strong> (RS256 private key)</li>
        <li><strong>Embeddings biom√©tricos cifrados</strong></li>
      </ul>

      <h3>6.5.2 Pol√≠ticas de Contrase√±as</h3>

      <div class="note">
        <strong>Requisitos de Contrase√±a:</strong>
        <ul>
          <li>M√≠nimo 12 caracteres</li>
          <li>
            Al menos 1 may√∫scula, 1 min√∫scula, 1 n√∫mero, 1 car√°cter especial
          </li>
          <li>
            No puede contener datos personales (nombre, email, fecha nacimiento)
          </li>
          <li>
            No puede ser una contrase√±a com√∫n (checklist de 10,000 passwords
            comunes)
          </li>
          <li>Historial de √∫ltimas 5 contrase√±as (no reutilizar)</li>
          <li>Expiraci√≥n cada 90 d√≠as (opcional, configurable)</li>
          <li>Bloqueo tras 5 intentos fallidos (30 minutos)</li>
        </ul>
      </div>

      <h3>6.5.3 Rate Limiting y Protecci√≥n Anti-Fuerza Bruta</h3>

      <table>
        <thead>
          <tr>
            <th>Evento</th>
            <th>Umbral</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Login fallido</td>
            <td>3 intentos en 5 minutos</td>
            <td>Activar CAPTCHA</td>
          </tr>
          <tr>
            <td>Login fallido</td>
            <td>5 intentos en 15 minutos</td>
            <td>Bloqueo temporal (30 min)</td>
          </tr>
          <tr>
            <td>Login fallido</td>
            <td>10 intentos en 1 hora</td>
            <td>Bloqueo cuenta (requiere reset)</td>
          </tr>
          <tr>
            <td>Requests de login</td>
            <td>&gt;10 req/min desde misma IP</td>
            <td>Rate limiting + CAPTCHA</td>
          </tr>
          <tr>
            <td>Solicitudes OTP</td>
            <td>&gt;3 en 10 minutos</td>
            <td>Bloqueo temporal</td>
          </tr>
        </tbody>
      </table>

      <h3>6.5.4 Notificaciones de Seguridad</h3>

      <ul>
        <li>
          <strong>Login desde nuevo dispositivo:</strong> Email + SMS (siempre)
        </li>
        <li>
          <strong>Login desde pa√≠s desconocido:</strong> Email + SMS + Bloqueo
          temporal
        </li>
        <li><strong>Cambio de contrase√±a:</strong> Email + SMS (siempre)</li>
        <li>
          <strong>Cambio de email:</strong> Email antiguo + Email nuevo + SMS
        </li>
        <li><strong>Intentos fallidos:</strong> Email despu√©s de 3 intentos</li>
        <li><strong>Bloqueo de cuenta:</strong> Email + SMS (inmediato)</li>
      </ul>
    </div>

    <h2>6.6 Proveedores de Biometr√≠a y APIs</h2>

    <div class="section">
      <h3>6.6.1 Sensores Biom√©tricos Nativos</h3>

      <table>
        <thead>
          <tr>
            <th>Plataforma</th>
            <th>Tecnolog√≠a</th>
            <th>API</th>
            <th>Storage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>iOS</strong></td>
            <td>Face ID / Touch ID</td>
            <td>LocalAuthentication framework</td>
            <td>Secure Enclave (hardware)</td>
          </tr>
          <tr>
            <td><strong>Android</strong></td>
            <td>Face Recognition / Fingerprint</td>
            <td>BiometricPrompt API</td>
            <td>Android Keystore (hardware-backed)</td>
          </tr>
        </tbody>
      </table>

      <h3>6.6.2 Servicios Cloud para Verificaci√≥n</h3>

      <table>
        <thead>
          <tr>
            <th>Proveedor</th>
            <th>Servicio</th>
            <th>Capacidad</th>
            <th>Costo</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>AWS Rekognition</strong></td>
            <td>Face Comparison + Liveness</td>
            <td>Similarity score, detecci√≥n de vida</td>
            <td>$1.00 por 1,000 im√°genes</td>
          </tr>
          <tr>
            <td><strong>Azure Face API</strong></td>
            <td>Face Verification + Liveness</td>
            <td>Similarity score, anti-spoofing</td>
            <td>$1.00 por 1,000 transacciones</td>
          </tr>
          <tr>
            <td><strong>Google Cloud Vision</strong></td>
            <td>Face Detection</td>
            <td>Detecci√≥n facial, landmarks</td>
            <td>$1.50 por 1,000 im√°genes</td>
          </tr>
        </tbody>
      </table>

      <div class="success">
        <strong>Recomendaci√≥n:</strong> AWS Rekognition por:
        <ul>
          <li>Excelente precisi√≥n (99.9%)</li>
          <li>Liveness detection integrado</li>
          <li>Bajo costo ($1/1000 im√°genes)</li>
          <li>Baja latencia (&lt;500ms)</li>
          <li>Cumplimiento SOC 2, ISO 27001</li>
        </ul>
      </div>

      <h3>6.6.3 Liveness Detection</h3>

      <p>
        <strong>¬øQu√© es Liveness Detection?</strong> T√©cnica para detectar si la
        persona frente a la c√°mara es real (no una foto, video o m√°scara).
      </p>

      <p><strong>T√©cnicas Implementadas:</strong></p>
      <ul>
        <li>
          <strong>Passive Liveness:</strong> An√°lisis de textura de piel,
          parpadeo natural, micro-expresiones
        </li>
        <li>
          <strong>Active Liveness:</strong> Challenge-response (gira cabeza,
          sonr√≠e, parpadea)
        </li>
        <li>
          <strong>3D Depth Analysis:</strong> Detecci√≥n de profundidad (c√°maras
          3D como Face ID)
        </li>
        <li>
          <strong>Motion Analysis:</strong> Detecci√≥n de movimiento natural de
          rostro
        </li>
      </ul>
    </div>

    <h2>6.7 Estructura de JWT (Access Token)</h2>

    <div class="section">
      <h3>6.7.1 Payload del JWT</h3>

      <pre><code class="language-javascript">
{
  // Registered claims (RFC 7519)
  "iss": "https://auth.bp-bank.com",      // Issuer
  "sub": "user-uuid-12345",                // Subject (user ID)
  "aud": "bp-banking-app",                 // Audience
  "exp": 1696684800,                       // Expiration (15 min)
  "iat": 1696683900,                       // Issued at
  "jti": "jwt-uuid-67890",                 // JWT ID (para revocaci√≥n)
  
  // Custom claims
  "email": "usuario@example.com",
  "name": "Juan P√©rez",
  "roles": ["customer"],
  "permissions": [
    "accounts:read",
    "transactions:read",
    "transfers:create"
  ],
  "mfa_verified": true,
  "biometric_enabled": true,
  "account_ids": ["acc-111", "acc-222"],
  
  // Security
  "ip": "192.168.1.100",
  "device_id": "device-uuid-999"
}
    </code></pre>

      <h3>6.7.2 Validaci√≥n del JWT</h3>

      <ol>
        <li>
          <strong>Firma v√°lida:</strong> Verificar con clave p√∫blica (RS256)
        </li>
        <li><strong>No expirado:</strong> exp > current_time</li>
        <li><strong>Issuer correcto:</strong> iss == expected_issuer</li>
        <li><strong>Audience correcto:</strong> aud == expected_audience</li>
        <li>
          <strong>No revocado:</strong> Verificar jti contra Redis (blacklist)
        </li>
        <li><strong>Claims requeridos:</strong> Validar roles y permissions</li>
      </ol>
    </div>

    <h2>6.8 Cumplimiento Normativo</h2>

    <div class="section">
      <div class="success">
        <h3>‚úì Requisitos Cubiertos</h3>

        <p><strong>ISO 27001 - Control A.9 (Access Control):</strong></p>
        <ul>
          <li>‚úì Autenticaci√≥n multifactor disponible</li>
          <li>‚úì Pol√≠ticas de contrase√±as robustas</li>
          <li>‚úì Logs de todos los accesos</li>
          <li>‚úì Revocaci√≥n de acceso implementada</li>
        </ul>

        <p><strong>PCI DSS Requirement 8:</strong></p>
        <ul>
          <li>‚úì Identificaci√≥n √∫nica por usuario</li>
          <li>‚úì Autenticaci√≥n multifactor para acceso remoto</li>
          <li>‚úì Contrase√±as cifradas en almacenamiento (bcrypt)</li>
          <li>‚úì Bloqueo tras intentos fallidos</li>
        </ul>

        <p><strong>GDPR Art. 32 - Security Measures:</strong></p>
        <ul>
          <li>‚úì Cifrado de datos biom√©tricos</li>
          <li>‚úì Pseudonimizaci√≥n de identificadores</li>
          <li>‚úì Control de acceso basado en roles (RBAC)</li>
          <li>‚úì Notificaciones de actividad sospechosa</li>
        </ul>

        <p><strong>GLBA - Safeguards Rule:</strong></p>
        <ul>
          <li>‚úì Autenticaci√≥n robusta implementada</li>
          <li>‚úì Monitoreo de accesos</li>
          <li>‚úì Protecci√≥n contra acceso no autorizado</li>
        </ul>
      </div>
    </div>

    <h2>6.9 Ventajas del Sistema de Autenticaci√≥n</h2>

    <div class="section">
      <div class="success">
        <h3>‚úì Beneficios Implementados</h3>

        <ol>
          <li>
            <strong>Seguridad Robusta:</strong> OAuth 2.0 + PKCE + Biometr√≠a +
            MFA = m√∫ltiples capas
          </li>
          <li>
            <strong>Excelente UX:</strong> Login biom√©trico en ~2 segundos
          </li>
          <li>
            <strong>Cumplimiento Total:</strong> ISO 27001, PCI DSS, GDPR, GLBA
            desde el dise√±o
          </li>
          <li>
            <strong>Escalable:</strong> OAuth 2.0 permite agregar nuevos m√©todos
            de autenticaci√≥n
          </li>
          <li>
            <strong>Auditable:</strong> Logs completos de todos los accesos y
            cambios
          </li>
          <li>
            <strong>Resiliente:</strong> M√∫ltiples m√©todos de autenticaci√≥n como
            fallback
          </li>
          <li>
            <strong>Privacy-First:</strong> Embeddings biom√©tricos cifrados,
            nunca im√°genes completas
          </li>
        </ol>
      </div>

      <div class="note">
        <strong>Tasa de Adopci√≥n Esperada:</strong>
        <ul>
          <li>Biometr√≠a (Face ID/Touch ID): 70-80% de usuarios</li>
          <li>Usuario + Contrase√±a + OTP: 15-20%</li>
          <li>Usuario + Contrase√±a: 5-10%</li>
        </ul>
      </div>
    </div>

    <div class="footer">
      <p>Propuesta de Arquitectura - Sistema Bancario BP | Cap√≠tulo 6 de 17</p>
    </div>

    <script src="mermaid.min.js"></script>
    <script src="panzoom.min.js"></script>
    <script src="app.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
  </body>
</html>
